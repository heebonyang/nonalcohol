<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí™œ ê´€ë¦¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f3f4f6; min-height: 100vh; color: #1f2937;
        }

        /* â”€â”€ ë©”ì¸ íƒ­ â”€â”€ */
        .main-nav {
            display: flex; background: white; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .main-tab {
            flex: 1; padding: 16px; border: none; background: transparent;
            font-size: 1rem; font-weight: 700; color: #6b7280; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.2s;
            font-family: inherit;
        }
        .main-tab:hover { background: #f9fafb; color: #1f2937; }
        .main-tab.active { color: #0284c7; border-bottom-color: #0284c7; background: #f0f9ff; }
        .app-section { display: none; }
        .app-section.active { display: block; }

        /* â•â• ê¸ˆì£¼ ì•± CSS â•â• */
        #app-jk { padding: 30px 20px; }
        #app-jk .container { max-width: 1000px; margin: auto; }
        #app-jk .header-card {
            background: #fff; padding: 30px; border-radius: 20px;
            text-align: center; margin-bottom: 25px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        #app-jk .sub-title { font-size: 1.2rem; color: #6b7280; font-weight: 600; margin-bottom: 10px; }
        #app-jk .main-streak { font-size: 4rem; font-weight: 800; color: #0284c7; display: block; }
        #app-jk .streak-unit { font-size: 1.5rem; color: #1f2937; vertical-align: middle; }
        #app-jk .input-card {
            background: #fff; padding: 25px; border-radius: 20px;
            margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        #app-jk .form-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
        #app-jk input, #app-jk select {
            border: 1px solid #d1d5db; padding: 12px 15px;
            border-radius: 10px; font-size: 0.95rem; outline: none; font-family: inherit;
        }
        #app-jk .reason-container { width: 100%; display: none; margin-top: 15px; }
        #app-jk .reason-input { width: 100%; border: 2px solid #fecaca !important; background: #fff1f2 !important; }
        #app-jk .btn-save {
            background: #0284c7; color: white; border: none;
            padding: 12px 35px; border-radius: 10px; font-weight: 700;
            cursor: pointer; font-family: inherit;
        }
        #app-jk .btn-save.edit-mode { background: #f59e0b; }
        #app-jk .table-card {
            background: #fff; border-radius: 20px; overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        #app-jk table { width: 100%; border-collapse: collapse; }
        #app-jk th {
            background: #f9fafb; padding: 15px; color: #4b5563;
            font-size: 0.85rem; border-bottom: 1px solid #e5e7eb;
        }
        #app-jk td { padding: 18px 15px; border-bottom: 1px solid #f3f4f6; text-align: center; }
        #app-jk .status-o { color: #059669; font-weight: 800; }
        #app-jk .status-x { color: #dc2626; font-weight: 800; }
        #app-jk .reason-label { font-size: 0.8rem; color: #ef4444; display: block; margin-top: 5px; font-style: italic; }
        #app-jk .btn-edit {
            background: #e5e7eb; color: #374151; border: none;
            padding: 6px 12px; border-radius: 6px; cursor: pointer;
            margin-right: 5px; font-family: inherit;
        }
        #app-jk .btn-del {
            background: #fee2e2; color: #b91c1c; border: none;
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-family: inherit;
        }

        /* â•â• ê°€ê³„ë¶€ ì•± CSS â•â• */
        #app-gk { padding: 16px; }
        #app-gk .container { max-width: 600px; margin: 0 auto; }
        #app-gk .dashboard {
            background: linear-gradient(135deg, #5a67d8 0%, #764ba2 100%);
            border-radius: 20px; padding: 22px; color: white;
            margin-bottom: 16px; box-shadow: 0 8px 24px rgba(90,103,216,0.35);
        }
        #app-gk .dashboard-title {
            font-size: 0.9rem; text-align: center; opacity: 0.85;
            margin-bottom: 14px; font-weight: 600;
        }
        #app-gk .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        #app-gk .stat-box { background: rgba(255,255,255,0.15); border-radius: 12px; padding: 11px 10px; text-align: center; }
        #app-gk .stat-label { font-size: 0.72rem; opacity: 0.8; margin-bottom: 4px; }
        #app-gk .stat-value { font-size: 1.1rem; font-weight: 700; }
        #app-gk .stat-value.red { color: #fbb6ce; }
        #app-gk .daily-budget-box {
            background: rgba(255,255,255,0.18); border-radius: 14px; padding: 16px;
            text-align: center; margin-bottom: 12px;
        }
        #app-gk .daily-budget-label { font-size: 0.8rem; opacity: 0.85; margin-bottom: 4px; }
        #app-gk .daily-budget-amount { font-size: 2.1rem; font-weight: 800; line-height: 1.1; }
        #app-gk .daily-budget-amount.over { color: #fbb6ce; }
        #app-gk .daily-budget-sub { font-size: 0.72rem; opacity: 0.7; margin-top: 5px; }
        #app-gk .progress-labels { display: flex; justify-content: space-between; font-size: 0.72rem; opacity: 0.82; margin-bottom: 5px; }
        #app-gk .progress-bar { height: 7px; background: rgba(255,255,255,0.25); border-radius: 999px; overflow: hidden; }
        #app-gk .progress-fill { height: 100%; background: white; border-radius: 999px; transition: width 0.6s ease; }
        #app-gk .notice {
            background: #fffbeb; border-left: 4px solid #f6ad55; border-radius: 10px;
            padding: 11px 14px; margin-bottom: 14px; font-size: 0.83rem; color: #744210;
        }
        #app-gk .notice h3 { font-size: 0.82rem; margin-bottom: 7px; color: #92400e; }
        #app-gk .notice-row { display: flex; justify-content: space-between; padding: 2px 0; }
        #app-gk .alert-banner {
            background: #fff5f5; border-left: 4px solid #fc8181; border-radius: 10px;
            padding: 10px 14px; margin-bottom: 14px; font-size: 0.83rem; color: #c53030;
        }
        #app-gk .gk-tabs { display: flex; gap: 8px; margin-bottom: 14px; overflow-x: auto; }
        #app-gk .gk-tab {
            padding: 8px 18px; border-radius: 999px; border: none; cursor: pointer;
            font-size: 0.83rem; font-weight: 600; white-space: nowrap;
            transition: background 0.2s; font-family: inherit;
        }
        #app-gk .gk-tab.active { background: #5a67d8; color: white; }
        #app-gk .gk-tab:not(.active) { background: white; color: #4a5568; }
        #app-gk .gk-tab:not(.active):hover { background: #e2e8f0; }
        #app-gk .card {
            background: white; border-radius: 14px; padding: 18px;
            margin-bottom: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        #app-gk .card h2 { font-size: 0.95rem; color: #4a5568; margin-bottom: 14px; font-weight: 700; }
        #app-gk .form-group { margin-bottom: 12px; }
        #app-gk .form-group label { display: block; font-size: 0.75rem; color: #718096; margin-bottom: 5px; font-weight: 600; }
        #app-gk .form-group input, #app-gk .form-group select {
            width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0;
            border-radius: 8px; font-size: 0.92rem; background: white; font-family: inherit;
        }
        #app-gk .form-group input:focus, #app-gk .form-group select:focus {
            outline: none; border-color: #5a67d8;
        }
        #app-gk .gk-row { display: flex; gap: 10px; }
        #app-gk .gk-row .form-group { flex: 1; min-width: 0; }
        #app-gk .btn {
            padding: 11px 18px; border: none; border-radius: 9px; cursor: pointer;
            font-size: 0.9rem; font-weight: 700; width: 100%;
            transition: opacity 0.2s; font-family: inherit;
        }
        #app-gk .btn:hover { opacity: 0.88; }
        #app-gk .btn-primary { background: #5a67d8; color: white; }
        #app-gk .btn-success { background: #48bb78; color: white; }
        #app-gk .btn-sm {
            font-size: 0.72rem; padding: 4px 10px; width: auto; border-radius: 999px;
            background: #fed7d7; color: #c53030; border: none; cursor: pointer;
            font-weight: 600; font-family: inherit;
        }
        #app-gk .btn-sm:hover { background: #fc8181; color: white; }
        #app-gk .btn-sm-edit {
            font-size: 0.72rem; padding: 4px 10px; width: auto; border-radius: 999px;
            background: #bee3f8; color: #2b6cb0; border: none; cursor: pointer;
            font-weight: 600; font-family: inherit;
        }
        #app-gk .btn-sm-edit:hover { background: #63b3ed; color: white; }
        #app-gk .btn-sm-confirm {
            font-size: 0.72rem; padding: 4px 10px; width: auto; border-radius: 999px;
            background: #c6f6d5; color: #276749; border: none; cursor: pointer;
            font-weight: 600; font-family: inherit;
        }
        #app-gk .btn-sm-confirm:hover { background: #48bb78; color: white; }
        #app-gk .btn-sm-unconfirm {
            font-size: 0.72rem; padding: 4px 10px; width: auto; border-radius: 999px;
            background: #e2e8f0; color: #718096; border: none; cursor: pointer;
            font-weight: 600; font-family: inherit;
        }
        #app-gk .btn-sm-unconfirm:hover { background: #a0aec0; color: white; }
        #app-gk .list-item { display: flex; justify-content: space-between; align-items: center; padding: 11px 0; border-bottom: 1px solid #f0f4f8; }
        #app-gk .list-item:last-child { border-bottom: none; }
        #app-gk .list-item .info .name { font-weight: 600; font-size: 0.92rem; }
        #app-gk .list-item .info .sub { font-size: 0.77rem; color: #a0aec0; margin-top: 2px; }
        #app-gk .list-item .right { display: flex; align-items: center; gap: 10px; }
        #app-gk .list-item .amount { font-weight: 700; color: #e53e3e; font-size: 0.95rem; }
        #app-gk .empty { text-align: center; color: #a0aec0; padding: 20px; font-size: 0.87rem; }
        #app-gk .info-box { background: #ebf4ff; border-radius: 10px; padding: 14px; font-size: 0.8rem; color: #2b6cb0; line-height: 1.7; }
        #app-gk .info-box p + p { margin-top: 4px; }
        #app-gk .divider { height: 1px; background: #f0f4f8; margin: 10px 0; }

        /* â•â• êµ¬ë… ê´€ë¦¬ CSS â•â• */
        #app-gk .sub-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 4px; }
        #app-gk .sub-summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px; padding: 12px 8px; color: white; text-align: center;
        }
        #app-gk .sub-summary-label { font-size: 0.68rem; opacity: 0.85; margin-bottom: 4px; }
        #app-gk .sub-summary-value { font-size: 0.95rem; font-weight: 700; }
        #app-gk .sub-badge {
            font-size: 0.65rem; padding: 2px 6px; border-radius: 999px;
            font-weight: 600; vertical-align: middle; margin-left: 3px;
        }
        #app-gk .sub-badge-monthly { background: #ebf4ff; color: #2b6cb0; }
        #app-gk .sub-badge-yearly  { background: #fefcbf; color: #744210; }
        #app-gk .sub-toggle { position: relative; display: inline-block; width: 36px; height: 20px; cursor: pointer; flex-shrink: 0; }
        #app-gk .sub-toggle input { opacity: 0; width: 0; height: 0; }
        #app-gk .sub-toggle-slider {
            position: absolute; inset: 0; background: #e2e8f0;
            border-radius: 999px; transition: 0.2s;
        }
        #app-gk .sub-toggle-slider:before {
            content: ''; position: absolute; width: 14px; height: 14px;
            background: white; border-radius: 50%; top: 3px; left: 3px; transition: 0.2s;
        }
        #app-gk .sub-toggle input:checked + .sub-toggle-slider { background: #5a67d8; }
        #app-gk .sub-toggle input:checked + .sub-toggle-slider:before { transform: translateX(16px); }
        #app-gk .sub-inactive { opacity: 0.4; }
        #app-gk .sub-next-date { font-size: 0.72rem; color: #a0aec0; margin-top: 2px; }
        #app-gk .sub-next-date.soon { color: #e53e3e; font-weight: 600; }
        #app-gk .sub-item-inner { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }

        /* â•â• ëª¨ë°”ì¼ ë°˜ì‘í˜• â•â• */
        @media (max-width: 600px) {
            /* íƒ­ */
            .main-tab { padding: 13px 8px; font-size: 0.88rem; }

            /* ê¸ˆì£¼ ì•± */
            #app-jk { padding: 14px 12px; }
            #app-jk .header-card { padding: 20px 16px; margin-bottom: 14px; }
            #app-jk .sub-title { font-size: 1rem; }
            #app-jk .main-streak { font-size: 3rem; }
            #app-jk .streak-unit { font-size: 1.2rem; }
            #app-jk .input-card { padding: 16px 14px; margin-bottom: 14px; }

            /* í¼: 2ì—´ ê·¸ë¦¬ë“œë¡œ ì „í™˜ */
            #app-jk .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            /* ë‚ ì§œÂ·ìŠ¤í¬ë¦°Â·AIÂ·ì €ì¥ ë²„íŠ¼ì€ ì „ì²´ ë„ˆë¹„ */
            #app-jk #targetDate,
            #app-jk #screen,
            #app-jk #ai { grid-column: 1 / -1; width: 100%; }
            #app-jk .btn-save {
                grid-column: 1 / -1; width: 100%;
                padding: 14px; font-size: 1rem;
            }
            /* iOS Safari ìë™ ì¤Œ ë°©ì§€ */
            #app-jk input, #app-jk select { font-size: 16px; }

            /* í…Œì´ë¸”: ê°€ë¡œ ìŠ¤í¬ë¡¤ */
            #app-jk .table-card { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 16px; }
            #app-jk table { min-width: 500px; }
            #app-jk th { padding: 11px 8px; font-size: 0.78rem; }
            #app-jk td { padding: 13px 8px; font-size: 0.84rem; }
            #app-jk .btn-edit,
            #app-jk .btn-del { padding: 5px 8px; font-size: 0.78rem; }
            #app-jk .btn-edit { margin-right: 3px; }

            /* ê°€ê³„ë¶€ ì•± */
            #app-gk { padding: 12px; }
            #app-gk .dashboard { padding: 16px; border-radius: 16px; }
            #app-gk .daily-budget-amount { font-size: 1.8rem; }
            #app-gk .card { padding: 14px; }
            /* iOS Safari ìë™ ì¤Œ ë°©ì§€ */
            #app-gk .form-group input,
            #app-gk .form-group select,
            #app-gk .form-group input[type="month"] { font-size: 16px; }
        }
    </style>
</head>
<body>

<!-- â•â• ë©”ì¸ íƒ­ ë‚´ë¹„ê²Œì´ì…˜ â•â• -->
<nav class="main-nav">
    <button class="main-tab active" onclick="switchApp('jk', this)">ğŸº ê¸ˆì£¼ 100ì¼</button>
    <button class="main-tab" onclick="switchApp('gk', this)">ğŸ’° D-Day ê°€ê³„ë¶€</button>
</nav>

<!-- â•â• ê¸ˆì£¼ ì•± â•â• -->
<div id="app-jk" class="app-section active">
    <div class="container">
        <div class="header-card">
            <div class="sub-title">ê¸ˆì£¼ 100ì¼ í”„ë¡œì íŠ¸</div>
            <div>
                <span class="main-streak" id="day-count">0</span>
                <span class="streak-unit" id="streak-text">ì¼ì°¨ ê¸ˆì£¼ ì¤‘</span>
            </div>
        </div>
        <div class="input-card">
            <div class="form-grid">
                <input type="date" id="targetDate" onchange="jk_resetInputs()">
                <select id="sober" onchange="jk_toggleReason()">
                    <option value="O">ê¸ˆì£¼ ì„±ê³µ O</option>
                    <option value="X">ê¸ˆì£¼ ì‹¤íŒ¨ X</option>
                </select>
                <select id="exercise">
                    <option value="O">ìš´ë™ O</option>
                    <option value="X">ìš´ë™ X</option>
                </select>
                <input type="text" id="screen" placeholder="ìŠ¤í¬ë¦° íƒ€ì„">
                <input type="text" id="ai" placeholder="AI ê³µë¶€ ë‚´ìš©">
                <button class="btn-save" id="save-btn" onclick="jk_addRecord()">ê¸°ë¡í•˜ê¸°</button>
            </div>
            <div class="reason-container" id="reason-container">
                <input type="text" id="reason" class="reason-input" placeholder="ì‹¤íŒ¨ ì›ì¸ì„ ê¸°ë¡í•˜ì„¸ìš”">
            </div>
        </div>
        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th><th>ê¸ˆì£¼ ì—¬ë¶€</th><th>ìš´ë™</th>
                        <th>ìŠ¤í¬ë¦° íƒ€ì„</th><th>AI ê³µë¶€ ë‚´ìš©</th><th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="data-list"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â•â• ê°€ê³„ë¶€ ì•± â•â• -->
<div id="app-gk" class="app-section">
    <div class="container">
        <div class="dashboard">
            <div class="dashboard-title" id="dash-title">ğŸ¯ ëª©í‘œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">ë‚¨ì€ ë‚ ì§œ</div><div class="stat-value" id="dash-dday">D-?</div></div>
                <div class="stat-box"><div class="stat-label">ë‹¬ì„±ë¥ </div><div class="stat-value" id="dash-pct">0%</div></div>
                <div class="stat-box"><div class="stat-label">í˜„ì¬ ì”ì•¡</div><div class="stat-value" id="dash-balance">-</div></div>
                <div class="stat-box"><div class="stat-label">ì˜¤ëŠ˜ê¹Œì§€ ì§€ì¶œ</div><div class="stat-value red" id="dash-month-spent">-</div></div>
            </div>
            <div class="daily-budget-box">
                <div class="daily-budget-label">ì˜¤ëŠ˜ ë‚¨ì€ ì§€ì¶œ ê°€ëŠ¥ì•¡</div>
                <div class="daily-budget-amount" id="dash-today-remain">ì„¤ì • í•„ìš”</div>
                <div class="daily-budget-sub" id="dash-today-sub"></div>
            </div>
            <div class="progress-labels">
                <span id="dash-saved-label">ì €ì¶• 0ì›</span>
                <span id="dash-goal-label">ëª©í‘œ 5,000,000ì›</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="dash-progress" style="width:0%"></div>
            </div>
        </div>

        <div class="notice" id="notice-upcoming" style="display:none">
            <h3>ğŸ“… ì•ìœ¼ë¡œ 7ì¼ ë‚´ ì˜ˆì • ê±°ë˜</h3>
            <div id="notice-list"></div>
        </div>
        <div class="alert-banner" id="alert-over" style="display:none">
            âš ï¸ ì˜¤ëŠ˜ ì§€ì¶œ ê°€ëŠ¥ì•¡ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ë¶€í„° ë” ì•„ê»´ì•¼ ëª©í‘œë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆì–´ìš”.
        </div>
        <div class="alert-banner" id="alert-pending" style="display:none">
            âš ï¸ ì˜ˆì •ì¼ì´ ì§€ë‚œ ë¯¸í™•ì¸ í•­ëª©ì´ <span id="alert-pending-count">0</span>ê±´ ìˆìŠµë‹ˆë‹¤. ì‹¤ì œ ê¸ˆì•¡ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.
        </div>

        <div class="gk-tabs">
            <button class="gk-tab active" onclick="showTab('log')">ğŸ“ ì§€ì¶œ ê¸°ë¡</button>
            <button class="gk-tab" onclick="showTab('income')">ğŸ’° ì˜ˆì • ìˆ˜ì…</button>
            <button class="gk-tab" onclick="showTab('fixed')">ğŸ”’ ì˜ˆì • ê³ ì •ë¹„</button>
            <button class="gk-tab" onclick="showTab('subscription')">ğŸ“± êµ¬ë…</button>
            <button class="gk-tab" onclick="showTab('settings')">âš™ï¸ ì„¤ì •</button>
        </div>

        <div id="tab-log">
            <div class="card">
                <h2>ì§€ì¶œ ì¶”ê°€</h2>
                <div class="gk-row">
                    <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="log-date"></div>
                    <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="number" id="log-amount" placeholder="0" min="0"></div>
                </div>
                <div class="form-group"><label>ë‚´ìš©</label><input type="text" id="log-desc" placeholder="ì˜ˆ: í¸ì˜ì , ì ì‹¬ì‹ì‚¬"></div>
                <button class="btn btn-primary" onclick="addSpending()">+ ì§€ì¶œ ì¶”ê°€</button>
            </div>
            <div class="card">
                <h2>ì§€ì¶œ ë‚´ì—­</h2>
                <div id="log-list"><div class="empty">ì•„ì§ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>

        <div id="tab-income" style="display:none">
            <div class="card">
                <h2>ì˜ˆì • ìˆ˜ì… ì¶”ê°€</h2>
                <div class="form-group"><label>í•­ëª©ëª…</label><input type="text" id="income-name" placeholder="ì˜ˆ: ì›”ê¸‰, ë³´ë„ˆìŠ¤, ì´ì ìˆ˜ì…"></div>
                <div class="gk-row">
                    <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="number" id="income-amount" placeholder="0" min="0"></div>
                    <div class="form-group"><label>ìˆ˜ì… ì˜ˆì •ì¼</label><input type="date" id="income-date"></div>
                </div>
                <button class="btn btn-success" id="income-submit-btn" onclick="addIncome()">+ ìˆ˜ì… ë“±ë¡</button>
            </div>
            <div class="card">
                <h2>ë“±ë¡ëœ ì˜ˆì • ìˆ˜ì…</h2>
                <div id="income-list"><div class="empty">ë“±ë¡ëœ ì˜ˆì • ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
                <div id="income-total-wrap" style="display:none">
                    <div class="divider"></div>
                    <div style="display:flex;justify-content:space-between;font-size:0.85rem;font-weight:700;color:#4a5568;padding-top:8px;">
                        <span>ì˜ˆì • ìˆ˜ì… í•©ê³„</span>
                        <span id="income-total-amount" style="color:#48bb78;"></span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-fixed" style="display:none">
            <div class="card">
                <h2>ğŸ“Š ì´ì ë‚©ë¶€ ê¸°ë¡</h2>
                <div class="form-group"><label>ëŒ€ì¶œëª…</label><input type="text" id="interest-loan-name" placeholder="ì˜ˆ: ì£¼íƒë‹´ë³´ëŒ€ì¶œ, ë§ˆì´ë„ˆìŠ¤í†µì¥"></div>
                <div class="gk-row">
                    <div class="form-group"><label>ë‚©ë¶€ì¼</label><input type="date" id="interest-date"></div>
                    <div class="form-group"><label>ë‚©ë¶€ ê¸ˆì•¡ (ì›)</label><input type="number" id="interest-amount" placeholder="0" min="0"></div>
                </div>
                <button class="btn btn-primary" onclick="addInterestLog()">+ ì´ì ê¸°ë¡ ì¶”ê°€</button>
            </div>
            <div class="card">
                <h2>ì´ì í†µê³„ &amp; ì˜ˆì¸¡</h2>
                <div id="interest-stats"><div class="empty">ì´ì ë‚©ë¶€ ê¸°ë¡ì„ ì¶”ê°€í•˜ë©´ í†µê³„ ë° ì˜ˆì¸¡ì´ í‘œì‹œë©ë‹ˆë‹¤</div></div>
            </div>
            <div class="card">
                <h2>ì˜ˆì • ê³ ì •ë¹„ ì¶”ê°€</h2>
                <div class="form-group"><label>í•­ëª©ëª…</label><input type="text" id="fixed-name" placeholder="ì˜ˆ: ì›”ì„¸, ì´ì, ë³´í—˜ë£Œ"></div>
                <div class="gk-row">
                    <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="number" id="fixed-amount" placeholder="0" min="0"></div>
                    <div class="form-group"><label>ì§€ì¶œ ì˜ˆì •ì¼</label><input type="date" id="fixed-date"></div>
                </div>
                <button class="btn btn-primary" id="fixed-submit-btn" onclick="addFixed()">+ ê³ ì •ë¹„ ë“±ë¡</button>
            </div>
            <div class="card">
                <h2>ë“±ë¡ëœ ì˜ˆì • ê³ ì •ë¹„</h2>
                <div id="fixed-list"><div class="empty">ë“±ë¡ëœ ê³ ì •ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>
                <div id="fixed-total-wrap" style="display:none">
                    <div class="divider"></div>
                    <div style="display:flex;justify-content:space-between;font-size:0.85rem;font-weight:700;color:#4a5568;padding-top:8px;">
                        <span>ì˜ˆì • ê³ ì •ë¹„ í•©ê³„</span>
                        <span id="fixed-total-amount" style="color:#e53e3e;"></span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-subscription" style="display:none">
            <div class="card" id="sub-summary-card" style="display:none">
                <h2>êµ¬ë… ìš”ì•½</h2>
                <div class="sub-summary-grid">
                    <div class="sub-summary-box">
                        <div class="sub-summary-label">ì›” ì˜ˆìƒ ì§€ì¶œ</div>
                        <div class="sub-summary-value" id="sub-monthly-total">0ì›</div>
                    </div>
                    <div class="sub-summary-box">
                        <div class="sub-summary-label">ì—°ê°„ ì´ì•¡</div>
                        <div class="sub-summary-value" id="sub-yearly-total">0ì›</div>
                    </div>
                    <div class="sub-summary-box">
                        <div class="sub-summary-label">í™œì„± êµ¬ë…</div>
                        <div class="sub-summary-value" id="sub-active-count">0ê°œ</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2 id="sub-form-title">êµ¬ë… ì„œë¹„ìŠ¤ ì¶”ê°€</h2>
                <div class="form-group">
                    <label>ì„œë¹„ìŠ¤ëª…</label>
                    <input type="text" id="sub-name" placeholder="ì˜ˆ: Netflix, ìœ íŠœë¸Œ í”„ë¦¬ë¯¸ì—„">
                </div>
                <div class="gk-row">
                    <div class="form-group">
                        <label>ì¹´í…Œê³ ë¦¬</label>
                        <select id="sub-category">
                            <option value="streaming">ğŸ“º ìŠ¤íŠ¸ë¦¬ë°</option>
                            <option value="music">ğŸµ ìŒì•…</option>
                            <option value="software">ğŸ’» ì†Œí”„íŠ¸ì›¨ì–´</option>
                            <option value="game">ğŸ® ê²Œì„</option>
                            <option value="cloud">â˜ï¸ í´ë¼ìš°ë“œ</option>
                            <option value="food">ğŸ” ìŒì‹/ë°°ë‹¬</option>
                            <option value="shopping">ğŸ›’ ì‡¼í•‘</option>
                            <option value="fitness">ğŸ‹ï¸ í”¼íŠ¸ë‹ˆìŠ¤</option>
                            <option value="education">ğŸ“š êµìœ¡</option>
                            <option value="etc">ğŸŒ ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê²°ì œ ì£¼ê¸°</label>
                        <select id="sub-cycle" onchange="subCycleChange()">
                            <option value="monthly">ë§¤ì›”</option>
                            <option value="yearly">ë§¤ë…„</option>
                        </select>
                    </div>
                </div>
                <div class="gk-row">
                    <div class="form-group">
                        <label>ê¸ˆì•¡ (ì›)</label>
                        <input type="number" id="sub-amount" placeholder="0" min="0">
                    </div>
                    <div class="form-group" id="sub-billing-day-wrap">
                        <label>ë§¤ì›” ê²°ì œì¼ (ì¼)</label>
                        <input type="number" id="sub-billing-day" placeholder="15" min="1" max="31">
                    </div>
                    <div class="form-group" id="sub-billing-date-wrap" style="display:none">
                        <label>ì—°ê°„ ê²°ì œ ê¸°ì¤€ì¼</label>
                        <input type="date" id="sub-billing-date">
                    </div>
                </div>
                <button class="btn btn-primary" id="sub-submit-btn" onclick="addSubscription()">+ êµ¬ë… ì¶”ê°€</button>
            </div>
            <div class="card">
                <h2>ë“±ë¡ëœ êµ¬ë… ì„œë¹„ìŠ¤</h2>
                <div id="sub-list"><div class="empty">ë“±ë¡ëœ êµ¬ë… ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>

        <div id="tab-settings" style="display:none">
            <div class="card">
                <h2>âš™ï¸ ê¸°ë³¸ ì„¤ì •</h2>
                <div class="form-group"><label>ëª©í‘œ ê¸ˆì•¡ (ì›)</label><input type="number" id="s-goal" placeholder="5000000"></div>
                <div class="form-group"><label>ëª©í‘œ ë‚ ì§œ</label><input type="date" id="s-target"></div>
                <div class="divider"></div>
                <div class="form-group"><label>í˜„ì¬ ì”ì•¡ (ì›)</label><input type="number" id="s-balance" placeholder="0"></div>
                <div class="divider"></div>
                <div class="form-group"><label>ë¹„ìƒê¸ˆ ì˜ˆë¹„ (ì›)</label><input type="number" id="s-emergency" placeholder="1000000"></div>
                <button class="btn btn-success" onclick="saveSettings()">ì €ì¥</button>
            </div>
            <div class="card">
                <div class="info-box">
                    <p>ğŸ’¡ <strong>ì¼ì¼ ì§€ì¶œ ê°€ëŠ¥ì•¡ ê³„ì‚° ë°©ì‹</strong></p>
                    <p>í˜„ì¬ì”ì•¡ + ëª©í‘œì¼ ì „ ì˜ˆì • ìˆ˜ì… âˆ’ ëª©í‘œì¼ ì „ ì˜ˆì • ê³ ì •ë¹„ âˆ’ ì´ì ì˜ˆì¸¡ì•¡ âˆ’ ëª©í‘œê¸ˆì•¡ âˆ’ ë¹„ìƒê¸ˆ = ì•ìœ¼ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì´ ê¸ˆì•¡</p>
                    <p style="margin-top:4px;">ğŸ’¡ ì´ì ë‚©ë¶€ ê¸°ë¡ì´ ìŒ“ì¼ìˆ˜ë¡ ì˜ˆì¸¡ ì •í™•ë„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤ (ì„ í˜• íšŒê·€ + ê°€ì¤‘ í‰ê· )</p>
                    <p style="margin-top:6px;">ì´ ê°€ìš©ê¸ˆì•¡ âˆ’ ì´ë¯¸ ê¸°ë¡í•œ ì§€ì¶œ = ë‚¨ì€ ê°€ìš©ê¸ˆì•¡ Ã· ë‚¨ì€ ë‚ ìˆ˜ = <strong>ì˜¤ëŠ˜ ê¶Œì¥ ì§€ì¶œ</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyCE7iN5FD2d8HegeNx0BQt6Af935k4_yjI",
    authDomain: "nonalcohol-f1fe7.firebaseapp.com",
    projectId: "nonalcohol-f1fe7",
    storageBucket: "nonalcohol-f1fe7.firebasestorage.app",
    messagingSenderId: "429464917450",
    appId: "1:429464917450:web:a6304e8624a5a336bfeb33"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// â”€â”€ ê³µí†µ ìœ í‹¸ â”€â”€
function todayStr() {
    const t = new Date();
    return `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;
}
function fmtDate(d) {
    const dt = (typeof d === 'string') ? new Date(d) : d;
    return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
}
function pad(n) { return String(n).padStart(2, '0'); }
function fmtMoney(n) { return Math.round(n).toLocaleString('ko-KR') + 'ì›'; }
function fmtMonthDay(d) { return `${d.getMonth()+1}ì›” ${d.getDate()}ì¼`; }
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 6); }
function escHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// â”€â”€ íƒ­ ì „í™˜ â”€â”€
function switchApp(name, btn) {
    document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.main-tab').forEach(el => el.classList.remove('active'));
    document.getElementById('app-' + name).classList.add('active');
    btn.classList.add('active');
}
window.switchApp = switchApp;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ê¸ˆì£¼ ì•± (jk) â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const JK_DOC_REF = doc(db, 'challenge', 'main');
let D_jk = { records: [] };

function getCurrentStreak(records) {
    const sorted = [...records].sort((a, b) => b.date.localeCompare(a.date));
    let streak = 0;
    for (const r of sorted) {
        if (r.sober === 'O') streak++;
        else break;
    }
    return streak;
}

async function jk_load() {
    try {
        const snap = await getDoc(JK_DOC_REF);
        if (snap.exists()) D_jk = { records: [], ...snap.data() };
    } catch (e) {
        console.error('ê¸ˆì£¼ ë¡œë“œ ì‹¤íŒ¨:', e);
    }
    jk_renderTable();
}

function jk_save() {
    setDoc(JK_DOC_REF, D_jk).catch(err => console.error('ê¸ˆì£¼ ì €ì¥ ì‹¤íŒ¨:', err));
}

function jk_updateSoberCounter() {
    const streak = getCurrentStreak(D_jk.records);
    const countElem = document.getElementById('day-count');
    const textElem  = document.getElementById('streak-text');
    countElem.innerText = streak;
    if (streak === 0) {
        countElem.style.color = '#dc2626';
        textElem.innerText = 'ì¼ì°¨ - ë‹¤ì‹œ ì‹œì‘í•´ë´ìš”!';
    } else {
        countElem.style.color = '#0284c7';
        textElem.innerText = 'ì¼ì°¨ ê¸ˆì£¼ ì¤‘';
    }
}

function jk_renderTable() {
    const tbody = document.getElementById('data-list');
    tbody.innerHTML = '';
    const sorted = [...D_jk.records].sort((a, b) => b.date.localeCompare(a.date));
    sorted.forEach(r => {
        const reasonHtml = r.reason ? `<span class="reason-label">ì‚¬ìœ : ${escHtml(r.reason)}</span>` : '';
        const safeDate     = escHtml(r.date);
        const safeSober    = escHtml(r.sober);
        const safeExercise = escHtml(r.exercise);
        const safeScreen   = escHtml(r.screen).replace(/'/g, '&#39;');
        const safeAi       = escHtml(r.ai).replace(/'/g, '&#39;');
        const safeReason   = escHtml(r.reason || '').replace(/'/g, '&#39;');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:600;color:#4b5563;">${safeDate}</td>
            <td><span class="${r.sober === 'O' ? 'status-o' : 'status-x'}">${safeSober}</span>${reasonHtml}</td>
            <td class="${r.exercise === 'O' ? 'status-o' : 'status-x'}">${safeExercise}</td>
            <td>${escHtml(r.screen)}</td>
            <td style="text-align:left;font-size:0.9rem;">${escHtml(r.ai)}</td>
            <td>
                <button class="btn-edit" onclick="jk_editItem('${safeDate}','${safeSober}','${safeExercise}','${safeScreen}','${safeAi}','${safeReason}')">ìˆ˜ì •</button>
                <button class="btn-del"  onclick="jk_deleteRecord('${safeDate}')">ì‚­ì œ</button>
            </td>`;
        tbody.appendChild(tr);
    });
    jk_updateSoberCounter();
}

function jk_toggleReason() {
    const isX = document.getElementById('sober').value === 'X';
    document.getElementById('reason-container').style.display = isX ? 'block' : 'none';
    if (!isX) document.getElementById('reason').value = '';
}

function jk_resetInputs() {
    document.getElementById('sober').value    = 'O';
    document.getElementById('exercise').value = 'O';
    document.getElementById('screen').value   = '';
    document.getElementById('ai').value       = '';
    document.getElementById('reason').value   = '';
    jk_toggleReason();
    const btn = document.getElementById('save-btn');
    btn.innerText = 'ê¸°ë¡í•˜ê¸°';
    btn.classList.remove('edit-mode');
}

function jk_addRecord() {
    const date     = document.getElementById('targetDate').value;
    const sober    = document.getElementById('sober').value;
    const exercise = document.getElementById('exercise').value;
    const screen   = document.getElementById('screen').value;
    const ai       = document.getElementById('ai').value;
    const reason   = sober === 'O' ? '' : document.getElementById('reason').value;
    if (!date) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

    const idx = D_jk.records.findIndex(r => r.date === date);
    const newRecord = { date, sober, exercise, screen, ai, reason };
    if (idx >= 0) {
        D_jk.records[idx] = newRecord;
    } else {
        D_jk.records.push(newRecord);
    }
    jk_save();

    document.getElementById('save-btn').innerText = 'ê¸°ë¡í•˜ê¸°';
    document.getElementById('save-btn').classList.remove('edit-mode');
    document.getElementById('screen').value = '';
    document.getElementById('ai').value     = '';
    document.getElementById('reason').value = '';
    jk_toggleReason();
    jk_renderTable();
}

function jk_editItem(date, sober, exercise, screen, ai, reason) {
    document.getElementById('targetDate').value  = date;
    document.getElementById('sober').value       = sober;
    document.getElementById('exercise').value    = exercise;
    document.getElementById('screen').value      = screen;
    document.getElementById('ai').value          = ai;
    document.getElementById('reason').value      = sober === 'X' ? (reason || '') : '';
    document.getElementById('reason-container').style.display = sober === 'X' ? 'block' : 'none';
    const btn = document.getElementById('save-btn');
    btn.innerText = 'ìˆ˜ì • ì™„ë£Œ';
    btn.classList.add('edit-mode');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function jk_deleteRecord(date) {
    if (confirm('ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        D_jk.records = D_jk.records.filter(r => r.date !== date);
        jk_save();
        jk_renderTable();
    }
}

window.jk_toggleReason = jk_toggleReason;
window.jk_resetInputs  = jk_resetInputs;
window.jk_addRecord    = jk_addRecord;
window.jk_editItem     = jk_editItem;
window.jk_deleteRecord = jk_deleteRecord;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ê°€ê³„ë¶€ ì•± (gk) â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GK_DOC_REF = doc(db, 'budget', 'main');
let _editingIncomeId = null;
let _editingFixedId  = null;
let _editingSubId    = null;
const CATEGORY_ICONS = {
    streaming: 'ğŸ“º', music: 'ğŸµ', software: 'ğŸ’»', game: 'ğŸ®',
    cloud: 'â˜ï¸', food: 'ğŸ”', shopping: 'ğŸ›’', fitness: 'ğŸ‹ï¸',
    education: 'ğŸ“š', etc: 'ğŸŒ'
};
const DEFAULT = {
    goal: 5000000, targetDate: '2026-04-14', currentBalance: 0,
    balanceDate: todayStr(),
    emergencyFund: 1000000,
    incomeEvents: [],    // [{id, name, amount, date}]
    fixedExpenses: [],   // [{id, name, amount, date}]
    spendingLog: [],
    interestLog: [],     // [{id, loanName, date, amount}] â€” í†µê³„ ê¸°ë°˜ ì˜ˆì¸¡ìš©
    subscriptions: []    // [{id, name, category, cycle, amount, billingDay, billingDate, active}]
};
let D = { ...DEFAULT };

async function loadFromFirestore() {
    try {
        const snap = await getDoc(GK_DOC_REF);
        if (snap.exists()) D = { ...DEFAULT, ...snap.data() };
    } catch(e) { console.error('ë¡œë“œ ì‹¤íŒ¨:', e); }
}
function save() {
    setDoc(GK_DOC_REF, D).catch(err => console.error('ì €ì¥ ì‹¤íŒ¨:', err));
}

function calcDashboard() {
    const today = new Date(); today.setHours(0,0,0,0);
    const target = new Date(D.targetDate); target.setHours(23,59,59,999);
    const remainDays = Math.max(1, Math.ceil((target - today) / 86400000));

    const balanceDateObj = new Date(D.balanceDate || '2000-01-01'); balanceDateObj.setHours(0,0,0,0);

    // í™•ì¸ëœ ìˆ˜ì…/ê³ ì •ë¹„ (balanceDate ì´í›„, actualAmount ìš°ì„  ì‚¬ìš©)
    const confirmedIncome = (D.incomeEvents || [])
        .filter(x => x.confirmed && new Date(x.date) >= balanceDateObj)
        .reduce((s,x) => s + (x.actualAmount != null ? x.actualAmount : x.amount), 0);
    const confirmedFixed = (D.fixedExpenses || [])
        .filter(x => x.confirmed && new Date(x.date) >= balanceDateObj)
        .reduce((s,x) => s + (x.actualAmount != null ? x.actualAmount : x.amount), 0);

    const loggedSpent = D.spendingLog.filter(x => new Date(x.date) >= balanceDateObj).reduce((s,x) => s+x.amount, 0);
    const currentBalance = D.currentBalance + confirmedIncome - confirmedFixed - loggedSpent;

    // ëª©í‘œì¼ ì „ê¹Œì§€ ë¯¸ì™„ë£Œ ì˜ˆì • ìˆ˜ì…/ê³ ì •ë¹„ í•©ì‚°
    const futureIncome = (D.incomeEvents || [])
        .filter(x => !x.confirmed && new Date(x.date) > today && new Date(x.date) <= target)
        .reduce((s,x) => s + x.amount, 0);
    const futureFixed = (D.fixedExpenses || [])
        .filter(x => !x.confirmed && new Date(x.date) > today && new Date(x.date) <= target)
        .reduce((s,x) => s + x.amount, 0);

    // í†µê³„ ê¸°ë°˜ ì´ì ì˜ˆì¸¡ (ëª©í‘œì¼ ì „)
    const interestPredictions = calcInterestPredictions();
    const futureInterest = interestPredictions
        .filter(p => p.predictedDateObj > today && p.predictedDateObj <= target)
        .reduce((s,p) => s + p.predictedAmount, 0);

    const totalAvailable = currentBalance + futureIncome - futureFixed - futureInterest - D.goal - (D.emergencyFund || 0);
    const dailyMax = totalAvailable / remainDays;
    const todayKey = fmtDate(today);
    const todaySpent = D.spendingLog.filter(x => x.date === todayKey).reduce((s,x) => s+x.amount, 0);
    const todayRemain = dailyMax - todaySpent;
    const totalSpent = loggedSpent;
    const pct = Math.min(100, Math.max(0, (currentBalance / D.goal) * 100));

    // ì•ìœ¼ë¡œ 7ì¼ ë‚´ ë¯¸ì™„ë£Œ ì˜ˆì • ê±°ë˜ (ìˆ˜ì… + ê³ ì •ë¹„)
    const next7 = new Date(today); next7.setDate(next7.getDate() + 7);
    const upcomingIncome = (D.incomeEvents || [])
        .filter(x => !x.confirmed && new Date(x.date) >= today && new Date(x.date) <= next7)
        .map(x => ({ name: x.name, amount: x.amount, date: new Date(x.date), type: 'income' }));
    const upcomingFixed = (D.fixedExpenses || [])
        .filter(x => !x.confirmed && new Date(x.date) >= today && new Date(x.date) <= next7)
        .map(x => ({ name: x.name, amount: x.amount, date: new Date(x.date), type: 'expense' }));
    const upcomingInterest = interestPredictions
        .filter(p => p.predictedDateObj >= today && p.predictedDateObj <= next7)
        .map(p => ({ name: `${p.loanName} ì´ì (ì˜ˆì¸¡)`, amount: p.predictedAmount, date: p.predictedDateObj, type: 'expense' }));
    const upcomingItems = [...upcomingIncome, ...upcomingFixed, ...upcomingInterest].sort((a,b) => a.date - b.date);

    return { remainDays, currentBalance, dailyMax, todaySpent, todayRemain, totalSpent, pct, upcomingItems };
}

function updateDashboard() {
    const c = calcDashboard();
    document.getElementById('dash-title').textContent = `ğŸ¯ ${fmtMonthDay(new Date(D.targetDate))} ê¹Œì§€ ${fmtMoney(D.goal)} ëª¨ìœ¼ê¸°`;
    document.getElementById('dash-dday').textContent  = `D-${c.remainDays}`;
    document.getElementById('dash-pct').textContent   = `${Math.round(c.pct)}%`;
    document.getElementById('dash-balance').textContent     = fmtMoney(c.currentBalance);
    document.getElementById('dash-month-spent').textContent = fmtMoney(c.totalSpent);
    const remainEl = document.getElementById('dash-today-remain');
    if (c.todayRemain < 0) {
        remainEl.textContent = `- ${fmtMoney(Math.abs(c.todayRemain))}`;
        remainEl.className = 'daily-budget-amount over';
        document.getElementById('alert-over').style.display = 'block';
    } else {
        remainEl.textContent = fmtMoney(c.todayRemain);
        remainEl.className = 'daily-budget-amount';
        document.getElementById('alert-over').style.display = 'none';
    }
    document.getElementById('dash-today-sub').textContent  = `ì¼ ê¸°ì¤€ ${fmtMoney(c.dailyMax)} Â· ì˜¤ëŠ˜ ì§€ì¶œ ${fmtMoney(c.todaySpent)}`;
    document.getElementById('dash-saved-label').textContent = `í˜„ì¬ ${fmtMoney(c.currentBalance)}`;
    document.getElementById('dash-goal-label').textContent  = `ëª©í‘œ ${fmtMoney(D.goal)}`;
    document.getElementById('dash-progress').style.width    = `${c.pct}%`;
    const noticeEl = document.getElementById('notice-upcoming');
    if (c.upcomingItems.length > 0) {
        noticeEl.style.display = 'block';
        document.getElementById('notice-list').innerHTML = c.upcomingItems.map(it => {
            const sign  = it.type === 'income' ? '+' : 'âˆ’';
            const color = it.type === 'income' ? '#276749' : '#c53030';
            const tag   = it.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ';
            return `<div class="notice-row"><span>${escHtml(it.name)} <span style="opacity:0.75;font-size:0.72rem">(${it.date.getMonth()+1}/${it.date.getDate()} ${tag})</span></span><span style="color:${color};font-weight:700;">${sign}${fmtMoney(it.amount)}</span></div>`;
        }).join('');
    } else { noticeEl.style.display = 'none'; }

    // ì˜ˆì •ì¼ ê²½ê³¼ ë¯¸í™•ì¸ í•­ëª© ê²½ê³ 
    const todayDateStr = fmtDate(new Date());
    const overdueCount = [
        ...(D.incomeEvents || []).filter(x => !x.confirmed && x.date < todayDateStr),
        ...(D.fixedExpenses || []).filter(x => !x.confirmed && x.date < todayDateStr)
    ].length;
    const pendingEl = document.getElementById('alert-pending');
    if (overdueCount > 0) {
        document.getElementById('alert-pending-count').textContent = overdueCount;
        pendingEl.style.display = 'block';
    } else {
        pendingEl.style.display = 'none';
    }
}

function renderLog() {
    const el = document.getElementById('log-list');
    const sorted = [...D.spendingLog].sort((a,b) => b.date.localeCompare(a.date) || b.id.localeCompare(a.id));
    if (sorted.length === 0) { el.innerHTML = '<div class="empty">ì•„ì§ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
    const groups = {};
    sorted.forEach(item => { if (!groups[item.date]) groups[item.date] = []; groups[item.date].push(item); });
    let html = '';
    Object.entries(groups).forEach(([date, items]) => {
        const dayTotal = items.reduce((s,x) => s+x.amount, 0);
        html += `<div style="font-size:0.8rem;font-weight:700;color:#718096;padding:8px 0 4px;border-top:1px solid #f0f4f8;margin-top:4px;">${fmtMonthDay(new Date(date))} <span style="font-weight:400;color:#a0aec0;">í•©ê³„ ${fmtMoney(dayTotal)}</span></div>`;
        items.forEach(item => {
            html += `<div class="list-item"><div class="info"><div class="name">${escHtml(item.desc)}</div></div><div class="right"><span class="amount">âˆ’${fmtMoney(item.amount)}</span><button class="btn-sm" onclick="deleteSpending('${item.id}')">ì‚­ì œ</button></div></div>`;
        });
    });
    el.innerHTML = html;
}

function renderIncome() {
    const el = document.getElementById('income-list');
    const totalWrap = document.getElementById('income-total-wrap');
    const events = D.incomeEvents || [];
    if (events.length === 0) { el.innerHTML = '<div class="empty">ë“±ë¡ëœ ì˜ˆì • ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤</div>'; totalWrap.style.display = 'none'; return; }
    const sorted = [...events].sort((a,b) => a.date.localeCompare(b.date));
    const total  = sorted.reduce((s,x) => s+x.amount, 0);
    el.innerHTML = sorted.map(ie => {
        if (ie.confirmed) {
            const actual = ie.actualAmount != null ? ie.actualAmount : ie.amount;
            const diff = actual - ie.amount;
            const diffHtml = diff !== 0
                ? `<span style="color:${diff > 0 ? '#276749' : '#c53030'};font-size:0.77rem;"> (${diff > 0 ? '+' : 'âˆ’'}${fmtMoney(Math.abs(diff))})</span>`
                : '';
            return `<div class="list-item" style="opacity:0.8"><div class="info"><div class="name">âœ… ${escHtml(ie.name)}</div><div class="sub">${escHtml(ie.date)} Â· ì˜ˆì • ${fmtMoney(ie.amount)} â†’ ì‹¤ì œ ${fmtMoney(actual)}${diffHtml}</div></div><div class="right"><button class="btn-sm-unconfirm" onclick="unconfirmIncome('${ie.id}')">í™•ì¸ì·¨ì†Œ</button><button class="btn-sm" onclick="deleteIncome('${ie.id}')">ì‚­ì œ</button></div></div>`;
        } else {
            return `<div class="list-item"><div class="info"><div class="name">${escHtml(ie.name)}</div><div class="sub">${escHtml(ie.date)}</div></div><div class="right"><span class="amount" style="color:#276749;">+${fmtMoney(ie.amount)}</span><button class="btn-sm-confirm" onclick="confirmIncome('${ie.id}')">ìˆ˜ì…í™•ì¸</button><button class="btn-sm-edit" onclick="editIncome('${ie.id}')">ìˆ˜ì •</button><button class="btn-sm" onclick="deleteIncome('${ie.id}')">ì‚­ì œ</button></div></div>`;
        }
    }).join('');
    document.getElementById('income-total-amount').textContent = `+${fmtMoney(total)}`;
    totalWrap.style.display = 'block';
}

function renderFixed() {
    const el = document.getElementById('fixed-list');
    const totalWrap = document.getElementById('fixed-total-wrap');
    if (D.fixedExpenses.length === 0) { el.innerHTML = '<div class="empty">ë“±ë¡ëœ ê³ ì •ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</div>'; totalWrap.style.display = 'none'; return; }
    const sorted = [...D.fixedExpenses].sort((a,b) => a.date.localeCompare(b.date));
    const total  = sorted.reduce((s,x) => s+x.amount, 0);
    el.innerHTML = sorted.map(fe => {
        if (fe.confirmed) {
            const actual = fe.actualAmount != null ? fe.actualAmount : fe.amount;
            const saved = fe.amount - actual; // ì–‘ìˆ˜ = ì ˆì•½, ìŒìˆ˜ = ì´ˆê³¼
            const diffHtml = saved !== 0
                ? `<span style="color:${saved > 0 ? '#276749' : '#c53030'};font-size:0.77rem;"> (${saved > 0 ? 'ì ˆì•½ ' : 'ì´ˆê³¼ '}${fmtMoney(Math.abs(saved))})</span>`
                : '';
            return `<div class="list-item" style="opacity:0.8"><div class="info"><div class="name">âœ… ${escHtml(fe.name)}</div><div class="sub">${escHtml(fe.date)} Â· ì˜ˆì • ${fmtMoney(fe.amount)} â†’ ì‹¤ì œ ${fmtMoney(actual)}${diffHtml}</div></div><div class="right"><button class="btn-sm-unconfirm" onclick="unconfirmFixed('${fe.id}')">í™•ì¸ì·¨ì†Œ</button><button class="btn-sm" onclick="deleteFixed('${fe.id}')">ì‚­ì œ</button></div></div>`;
        } else {
            return `<div class="list-item"><div class="info"><div class="name">${escHtml(fe.name)}</div><div class="sub">${escHtml(fe.date)}</div></div><div class="right"><span class="amount">âˆ’${fmtMoney(fe.amount)}</span><button class="btn-sm-confirm" onclick="confirmFixed('${fe.id}')">ì§€ì¶œì™„ë£Œ</button><button class="btn-sm-edit" onclick="editFixed('${fe.id}')">ìˆ˜ì •</button><button class="btn-sm" onclick="deleteFixed('${fe.id}')">ì‚­ì œ</button></div></div>`;
        }
    }).join('');
    document.getElementById('fixed-total-amount').textContent = `âˆ’${fmtMoney(total)}`;
    totalWrap.style.display = 'block';
}

function renderSettings() {
    document.getElementById('s-goal').value      = D.goal;
    document.getElementById('s-target').value    = D.targetDate;
    document.getElementById('s-balance').value   = D.currentBalance;
    document.getElementById('s-emergency').value = D.emergencyFund ?? 1000000;
}

function showTab(name) {
    ['log','income','fixed','subscription','settings'].forEach(t => {
        document.getElementById(`tab-${t}`).style.display = t === name ? 'block' : 'none';
    });
    document.querySelectorAll('#app-gk .gk-tab').forEach((el, i) => {
        el.classList.toggle('active', ['log','income','fixed','subscription','settings'][i] === name);
    });
    if (name === 'settings') renderSettings();
    if (name === 'subscription') renderSubscriptions();
}

function addSpending() {
    const date   = document.getElementById('log-date').value;
    const amount = parseInt(document.getElementById('log-amount').value);
    const desc   = document.getElementById('log-desc').value.trim();
    if (!date || !desc || !amount || amount <= 0) { alert('ë‚ ì§œ, ë‚´ìš©, ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    D.spendingLog.push({ id: uid(), date, desc, amount });
    save();
    document.getElementById('log-amount').value = '';
    document.getElementById('log-desc').value   = '';
    renderLog(); updateDashboard();
}
function deleteSpending(id) {
    D.spendingLog = D.spendingLog.filter(x => x.id !== id);
    save(); renderLog(); updateDashboard();
}
function editIncome(id) {
    const item = (D.incomeEvents || []).find(x => x.id === id);
    if (!item) return;
    _editingIncomeId = id;
    document.getElementById('income-name').value   = item.name;
    document.getElementById('income-amount').value = item.amount;
    document.getElementById('income-date').value   = item.date;
    const btn = document.getElementById('income-submit-btn');
    btn.textContent = 'âœï¸ ìˆ˜ì • ì™„ë£Œ';
    btn.style.background = '#f6ad55';
    document.getElementById('tab-income').scrollIntoView({ behavior: 'smooth' });
}
function addIncome() {
    const name   = document.getElementById('income-name').value.trim();
    const amount = parseInt(document.getElementById('income-amount').value);
    const date   = document.getElementById('income-date').value;
    if (!name || !amount || amount <= 0 || !date) { alert('í•­ëª©ëª…, ê¸ˆì•¡, ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (!D.incomeEvents) D.incomeEvents = [];
    if (_editingIncomeId) {
        const idx = D.incomeEvents.findIndex(x => x.id === _editingIncomeId);
        if (idx >= 0) D.incomeEvents[idx] = { id: _editingIncomeId, name, amount, date };
        _editingIncomeId = null;
        const btn = document.getElementById('income-submit-btn');
        btn.textContent = '+ ìˆ˜ì… ë“±ë¡';
        btn.style.background = '';
    } else {
        D.incomeEvents.push({ id: uid(), name, amount, date });
    }
    save();
    document.getElementById('income-name').value   = '';
    document.getElementById('income-amount').value = '';
    document.getElementById('income-date').value   = '';
    renderIncome(); updateDashboard();
}
function deleteIncome(id) {
    D.incomeEvents = (D.incomeEvents || []).filter(x => x.id !== id);
    save(); renderIncome(); updateDashboard();
}
function editFixed(id) {
    const item = D.fixedExpenses.find(x => x.id === id);
    if (!item) return;
    _editingFixedId = id;
    document.getElementById('fixed-name').value   = item.name;
    document.getElementById('fixed-amount').value = item.amount;
    document.getElementById('fixed-date').value   = item.date;
    const btn = document.getElementById('fixed-submit-btn');
    btn.textContent = 'âœï¸ ìˆ˜ì • ì™„ë£Œ';
    btn.style.background = '#f6ad55';
    document.getElementById('fixed-submit-btn').scrollIntoView({ behavior: 'smooth' });
}
function addFixed() {
    const name   = document.getElementById('fixed-name').value.trim();
    const amount = parseInt(document.getElementById('fixed-amount').value);
    const date   = document.getElementById('fixed-date').value;
    if (!name || !amount || amount <= 0 || !date) { alert('í•­ëª©ëª…, ê¸ˆì•¡, ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (_editingFixedId) {
        const idx = D.fixedExpenses.findIndex(x => x.id === _editingFixedId);
        if (idx >= 0) D.fixedExpenses[idx] = { id: _editingFixedId, name, amount, date };
        _editingFixedId = null;
        const btn = document.getElementById('fixed-submit-btn');
        btn.textContent = '+ ê³ ì •ë¹„ ë“±ë¡';
        btn.style.background = '';
    } else {
        D.fixedExpenses.push({ id: uid(), name, amount, date });
    }
    save();
    document.getElementById('fixed-name').value   = '';
    document.getElementById('fixed-amount').value = '';
    document.getElementById('fixed-date').value   = '';
    renderFixed(); updateDashboard();
}
function deleteFixed(id) {
    D.fixedExpenses = D.fixedExpenses.filter(x => x.id !== id);
    save(); renderFixed(); updateDashboard();
}

function confirmIncome(id) {
    const item = (D.incomeEvents || []).find(x => x.id === id);
    if (!item) return;
    const input = prompt(`ì‹¤ì œ ìˆ˜ì… ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆì •: ${item.amount.toLocaleString()}ì›)`, item.amount);
    if (input === null) return;
    const actual = parseInt(String(input).replace(/,/g, ''));
    if (isNaN(actual) || actual < 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    item.confirmed = true;
    item.actualAmount = actual;
    save(); renderIncome(); updateDashboard();
}
function unconfirmIncome(id) {
    const item = (D.incomeEvents || []).find(x => x.id === id);
    if (!item) return;
    item.confirmed = false;
    item.actualAmount = null;
    save(); renderIncome(); updateDashboard();
}
function confirmFixed(id) {
    const item = D.fixedExpenses.find(x => x.id === id);
    if (!item) return;
    const input = prompt(`ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆì •: ${item.amount.toLocaleString()}ì›)`, item.amount);
    if (input === null) return;
    const actual = parseInt(String(input).replace(/,/g, ''));
    if (isNaN(actual) || actual < 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    item.confirmed = true;
    item.actualAmount = actual;
    save(); renderFixed(); updateDashboard();
}
function unconfirmFixed(id) {
    const item = D.fixedExpenses.find(x => x.id === id);
    if (!item) return;
    item.confirmed = false;
    item.actualAmount = null;
    save(); renderFixed(); updateDashboard();
}
function saveSettings() {
    const goal          = parseInt(document.getElementById('s-goal').value);
    const targetDate    = document.getElementById('s-target').value;
    const balance       = parseInt(document.getElementById('s-balance').value) || 0;
    const emergencyFund = parseInt(document.getElementById('s-emergency').value) || 0;
    if (!goal || goal <= 0 || !targetDate) { alert('ëª©í‘œ ê¸ˆì•¡ê³¼ ëª©í‘œ ë‚ ì§œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (balance !== D.currentBalance) D.balanceDate = todayStr();
    D.goal = goal; D.targetDate = targetDate; D.currentBalance = balance; D.emergencyFund = emergencyFund;
    save(); updateDashboard(); alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// â”€â”€ ì´ì í†µê³„ ê¸°ë°˜ ì˜ˆì¸¡ â”€â”€

function calcInterestPredictions() {
    const logs = D.interestLog || [];
    if (logs.length === 0) return [];

    // ëŒ€ì¶œëª…ë³„ ê·¸ë£¹í™”
    const byLoan = {};
    logs.forEach(e => {
        if (!byLoan[e.loanName]) byLoan[e.loanName] = [];
        byLoan[e.loanName].push(e);
    });

    const today = new Date(); today.setHours(0,0,0,0);
    const allPredictions = [];

    Object.entries(byLoan).forEach(([loanName, entries]) => {
        const sorted = [...entries].sort((a,b) => a.date.localeCompare(b.date));
        const n = sorted.length;
        const totalW = n * (n + 1) / 2;

        // ë‚©ë¶€ì¼ ì˜ˆì¸¡: ë‚ ì§œì˜ ê°€ì¤‘ í‰ê·  (ìµœì‹  ê°€ì¤‘ì¹˜ ë†’ìŒ)
        const avgDay = Math.round(
            sorted.reduce((s, e, i) => s + new Date(e.date).getDate() * (i + 1), 0) / totalW
        );

        // ê¸ˆì•¡ ì„ í˜• íšŒê·€ (ì›” ì¸ë±ìŠ¤ ê¸°ì¤€)
        const firstDate = new Date(sorted[0].date);
        const toMonthIdx = d => (d.getFullYear() - firstDate.getFullYear()) * 12 + (d.getMonth() - firstDate.getMonth());
        const monthIdxs = sorted.map(e => toMonthIdx(new Date(e.date)));
        const amounts   = sorted.map(e => e.amount);
        const meanX = monthIdxs.reduce((s,x) => s+x, 0) / n;
        const meanY = amounts.reduce((s,y) => s+y, 0) / n;
        let slope = 0, intercept = meanY;
        if (n >= 2) {
            const num = monthIdxs.reduce((s,x,i) => s + (x - meanX) * (amounts[i] - meanY), 0);
            const den = monthIdxs.reduce((s,x) => s + (x - meanX) ** 2, 0);
            slope = den !== 0 ? num / den : 0;
            intercept = meanY - slope * meanX;
        }
        // ê°€ì¤‘ í‰ê·  (ì„ í˜• ì¶”ì„¸ê°€ ë¯¸ë¯¸í•  ë•Œ ì‚¬ìš©)
        const weightedAmt = amounts.reduce((s,a,i) => s + a * (i + 1), 0) / totalW;
        const useLinear   = Math.abs(slope) > meanY * 0.005; // ì›” 0.5% ì´ìƒ ë³€ë™ì´ë©´ ì„ í˜• ì¶”ì„¸ ì‚¬ìš©

        // ì‹ ë¢°ë„ (ë¶„ì‚° ë°˜ì˜)
        const variance = n >= 2 ? amounts.reduce((s,a) => s + (a - meanY) ** 2, 0) / n : 0;
        const cv = meanY > 0 ? Math.sqrt(variance) / meanY : 0;
        let confidence, confidenceLabel;
        if      (n === 1) { confidence = 40; confidenceLabel = 'ë°ì´í„° ë¶€ì¡±'; }
        else if (n === 2) { confidence = 60; confidenceLabel = 'ì°¸ê³ ìš©'; }
        else if (n <= 4)  { confidence = Math.round(75 - cv * 20); confidenceLabel = 'ë³´í†µ'; }
        else if (n <= 9)  { confidence = Math.round(85 - cv * 15); confidenceLabel = 'ë†’ìŒ'; }
        else              { confidence = Math.round(95 - cv * 10); confidenceLabel = 'ë§¤ìš° ë†’ìŒ'; }
        confidence = Math.max(30, Math.min(99, confidence));

        const lastDate = new Date(sorted[n-1].date);

        // í–¥í›„ 12ê°œì›” ì˜ˆì¸¡ ìƒì„±
        for (let m = 0; m < 12; m++) {
            const predDate = new Date(today);
            predDate.setDate(1);
            predDate.setMonth(predDate.getMonth() + m);
            const ym = `${predDate.getFullYear()}-${pad(predDate.getMonth()+1)}`;
            if (sorted.some(e => e.date.startsWith(ym))) continue; // ì´ë¯¸ ê¸°ë¡ëœ ë‹¬ì€ ê±´ë„ˆëœ€

            const predMonthIdx = toMonthIdx(predDate);
            const monthsFromLast = (predDate.getFullYear() - lastDate.getFullYear()) * 12
                                 + (predDate.getMonth()    - lastDate.getMonth());
            const predictedAmount = Math.max(0, Math.round(
                useLinear ? intercept + slope * predMonthIdx
                          : weightedAmt + slope * monthsFromLast
            ));

            const lastDayOfMonth = new Date(predDate.getFullYear(), predDate.getMonth() + 1, 0).getDate();
            const predictedDay   = Math.min(avgDay, lastDayOfMonth);
            const predictedDate  = `${predDate.getFullYear()}-${pad(predDate.getMonth()+1)}-${pad(predictedDay)}`;
            const predictedDateObj = new Date(predictedDate);

            if (predictedDateObj >= today) {
                allPredictions.push({
                    loanName, predictedDate, predictedDateObj,
                    predictedAmount, confidence, confidenceLabel,
                    dataPoints: n, avgDay, slope: Math.round(slope)
                });
            }
        }
    });

    return allPredictions.sort((a,b) => a.predictedDate.localeCompare(b.predictedDate));
}

function renderInterestStats() {
    const el   = document.getElementById('interest-stats');
    const logs = D.interestLog || [];
    if (logs.length === 0) {
        el.innerHTML = '<div class="empty">ì´ì ë‚©ë¶€ ê¸°ë¡ì„ ì¶”ê°€í•˜ë©´ í†µê³„ ë° ì˜ˆì¸¡ì´ í‘œì‹œë©ë‹ˆë‹¤</div>';
        return;
    }

    const byLoan = {};
    logs.forEach(e => {
        if (!byLoan[e.loanName]) byLoan[e.loanName] = [];
        byLoan[e.loanName].push(e);
    });
    const predictions = calcInterestPredictions();
    let html = '';

    Object.entries(byLoan).forEach(([loanName, entries], idx) => {
        if (idx > 0) html += '<div class="divider" style="margin:14px 0;"></div>';
        const sorted   = [...entries].sort((a,b) => b.date.localeCompare(a.date));
        const loanPreds = predictions.filter(p => p.loanName === loanName);
        const nextPred  = loanPreds[0];
        const n = entries.length;

        html += `<div style="font-weight:700;font-size:0.92rem;color:#4a5568;margin-bottom:10px;display:flex;justify-content:space-between;">`;
        html += `<span>ğŸ¦ ${escHtml(loanName)}</span><span style="font-size:0.75rem;color:#a0aec0;font-weight:400;">ê¸°ë¡ ${n}ê±´</span></div>`;

        if (nextPred) {
            const slopeAbs  = Math.abs(nextPred.slope);
            const slopeText = nextPred.slope < -100
                ? `<span style="color:#48bb78;">ê°ì†Œ ì¶”ì„¸ (ì›” âˆ’${fmtMoney(slopeAbs)})</span>`
                : nextPred.slope > 100
                ? `<span style="color:#fc8181;">ì¦ê°€ ì¶”ì„¸ (ì›” +${fmtMoney(slopeAbs)})</span>`
                : '<span style="color:#718096;">ì•ˆì •ì </span>';
            const barColor = nextPred.confidence >= 85 ? '#48bb78' : nextPred.confidence >= 60 ? '#f6ad55' : '#fc8181';
            html += `<div style="background:#f8fafc;border-radius:10px;padding:12px;margin-bottom:10px;font-size:0.8rem;line-height:2.1;">`;
            html += `<div style="display:flex;justify-content:space-between;"><span style="color:#718096;">ì˜ˆìƒ ë‚©ë¶€ì¼</span><span style="font-weight:700;">ë§¤ì›” ${nextPred.avgDay}ì¼</span></div>`;
            html += `<div style="display:flex;justify-content:space-between;"><span style="color:#718096;">ë‹¤ìŒ ì˜ˆì •</span><span style="font-weight:700;color:#c53030;">${nextPred.predictedDate} Â· ${fmtMoney(nextPred.predictedAmount)}</span></div>`;
            html += `<div style="display:flex;justify-content:space-between;"><span style="color:#718096;">ê¸ˆì•¡ ì¶”ì„¸</span>${slopeText}</div>`;
            html += `<div style="display:flex;justify-content:space-between;align-items:center;"><span style="color:#718096;">ì˜ˆì¸¡ ì‹ ë¢°ë„</span>`;
            html += `<span style="display:flex;align-items:center;gap:6px;">`;
            html += `<div style="width:70px;height:5px;background:#e2e8f0;border-radius:999px;overflow:hidden;"><div style="width:${nextPred.confidence}%;height:100%;background:${barColor};border-radius:999px;"></div></div>`;
            html += `<span style="font-weight:700;font-size:0.77rem;color:${barColor};">${nextPred.confidenceLabel}</span></span></div>`;
            html += `</div>`;

            // í–¥í›„ 3ê°œì›” ì˜ˆì¸¡ ëª©ë¡
            html += `<div style="font-size:0.77rem;font-weight:700;color:#718096;margin-bottom:4px;">í–¥í›„ ì˜ˆì¸¡</div>`;
            loanPreds.slice(0, 3).forEach(p => {
                const pBarColor = p.confidence >= 85 ? '#48bb78' : p.confidence >= 60 ? '#f6ad55' : '#fc8181';
                html += `<div class="list-item" style="padding:7px 0;">`;
                html += `<div class="info"><div class="name" style="font-size:0.83rem;">${p.predictedDate}</div>`;
                html += `<div class="sub">ì‹ ë¢°ë„ <span style="color:${pBarColor};font-weight:700;">${p.confidence}%</span></div></div>`;
                html += `<div class="right"><span style="color:#e53e3e;font-weight:700;font-size:0.88rem;">~${fmtMoney(p.predictedAmount)}</span></div></div>`;
            });
        }

        // ë‚©ë¶€ ê¸°ë¡ ë‚´ì—­
        html += `<div style="font-size:0.77rem;font-weight:700;color:#718096;margin:10px 0 4px;">ë‚©ë¶€ ê¸°ë¡</div>`;
        sorted.forEach(e => {
            html += `<div class="list-item" style="padding:7px 0;">`;
            html += `<div class="info"><div class="name" style="font-size:0.83rem;">${escHtml(e.date)}</div></div>`;
            html += `<div class="right"><span class="amount" style="font-size:0.88rem;">âˆ’${fmtMoney(e.amount)}</span>`;
            html += `<button class="btn-sm" onclick="deleteInterestLog('${e.id}')">ì‚­ì œ</button></div></div>`;
        });
    });

    el.innerHTML = html;
}

function addInterestLog() {
    const loanName = document.getElementById('interest-loan-name').value.trim();
    const date     = document.getElementById('interest-date').value;
    const amount   = parseInt(document.getElementById('interest-amount').value);
    if (!loanName || !date || !amount || amount <= 0) { alert('ëŒ€ì¶œëª…, ë‚©ë¶€ì¼, ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (!D.interestLog) D.interestLog = [];
    D.interestLog.push({ id: uid(), loanName, date, amount });
    save();
    document.getElementById('interest-loan-name').value = '';
    document.getElementById('interest-amount').value    = '';
    renderInterestStats(); updateDashboard();
}

function deleteInterestLog(id) {
    D.interestLog = (D.interestLog || []).filter(x => x.id !== id);
    save(); renderInterestStats(); updateDashboard();
}

// â”€â”€ êµ¬ë… ê´€ë¦¬ â”€â”€
function subCycleChange() {
    const cycle = document.getElementById('sub-cycle').value;
    document.getElementById('sub-billing-day-wrap').style.display  = cycle === 'monthly' ? '' : 'none';
    document.getElementById('sub-billing-date-wrap').style.display = cycle === 'yearly'  ? '' : 'none';
}

function getNextBillingDate(sub) {
    const today = new Date(); today.setHours(0,0,0,0);
    if (sub.cycle === 'monthly') {
        const day = sub.billingDay || 1;
        let d = new Date(today.getFullYear(), today.getMonth(), day);
        if (d < today) d = new Date(today.getFullYear(), today.getMonth() + 1, day);
        return d;
    } else {
        const ref = new Date(sub.billingDate);
        let d = new Date(today.getFullYear(), ref.getMonth(), ref.getDate());
        if (d < today) d = new Date(today.getFullYear() + 1, ref.getMonth(), ref.getDate());
        return d;
    }
}

function calcSubSummary() {
    const subs = (D.subscriptions || []).filter(s => s.active);
    const monthlyTotal = subs.reduce((sum, s) =>
        sum + (s.cycle === 'monthly' ? s.amount : Math.round(s.amount / 12)), 0);
    const yearlyTotal  = subs.reduce((sum, s) =>
        sum + (s.cycle === 'monthly' ? s.amount * 12 : s.amount), 0);
    return { monthlyTotal, yearlyTotal, activeCount: subs.length };
}

function renderSubscriptions() {
    const subs = D.subscriptions || [];
    const summaryCard = document.getElementById('sub-summary-card');
    const el = document.getElementById('sub-list');

    if (subs.length === 0) {
        summaryCard.style.display = 'none';
        el.innerHTML = '<div class="empty">ë“±ë¡ëœ êµ¬ë… ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    const { monthlyTotal, yearlyTotal, activeCount } = calcSubSummary();
    summaryCard.style.display = 'block';
    document.getElementById('sub-monthly-total').textContent = fmtMoney(monthlyTotal);
    document.getElementById('sub-yearly-total').textContent  = fmtMoney(yearlyTotal);
    document.getElementById('sub-active-count').textContent  = `${activeCount}ê°œ`;

    const today = new Date(); today.setHours(0,0,0,0);
    const sorted = [...subs].sort((a, b) => {
        if (a.active !== b.active) return a.active ? -1 : 1;
        return getNextBillingDate(a) - getNextBillingDate(b);
    });

    el.innerHTML = sorted.map(sub => {
        const icon      = CATEGORY_ICONS[sub.category] || 'ğŸŒ';
        const nextDate  = getNextBillingDate(sub);
        const daysLeft  = Math.ceil((nextDate - today) / 86400000);
        const isSoon    = daysLeft <= 7 && sub.active;
        const nextStr   = fmtDate(nextDate);
        const cycleBadge = sub.cycle === 'monthly' ? 'sub-badge-monthly' : 'sub-badge-yearly';
        const cycleLabel = sub.cycle === 'monthly' ? 'ë§¤ì›”' : 'ë§¤ë…„';
        const itemClass  = sub.active ? '' : 'sub-inactive';
        const dateClass  = isSoon ? 'sub-next-date soon' : 'sub-next-date';
        const daysText   = isSoon ? ` Â· D-${daysLeft}` : '';

        return `<div class="list-item ${itemClass}">
            <div class="sub-item-inner">
                <label class="sub-toggle" title="${sub.active ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}">
                    <input type="checkbox" ${sub.active ? 'checked' : ''} onchange="toggleSubscription('${sub.id}')">
                    <span class="sub-toggle-slider"></span>
                </label>
                <div class="info" style="min-width:0;">
                    <div class="name">${icon} ${escHtml(sub.name)}<span class="sub-badge ${cycleBadge}">${cycleLabel}</span></div>
                    <div class="${dateClass}">${nextStr}${daysText} Â· ${fmtMoney(sub.amount)}</div>
                </div>
            </div>
            <div class="right" style="flex-shrink:0;">
                <button class="btn-sm-edit" onclick="editSubscription('${sub.id}')">ìˆ˜ì •</button>
                <button class="btn-sm" onclick="deleteSubscription('${sub.id}')">ì‚­ì œ</button>
            </div>
        </div>`;
    }).join('');
}

function addSubscription() {
    const name     = document.getElementById('sub-name').value.trim();
    const category = document.getElementById('sub-category').value;
    const cycle    = document.getElementById('sub-cycle').value;
    const amount   = parseInt(document.getElementById('sub-amount').value);
    if (!name || !amount || amount <= 0) { alert('ì„œë¹„ìŠ¤ëª…ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

    let billingDay = null, billingDate = null;
    if (cycle === 'monthly') {
        billingDay = parseInt(document.getElementById('sub-billing-day').value);
        if (!billingDay || billingDay < 1 || billingDay > 31) { alert('ê²°ì œì¼ì„ 1~31 ì‚¬ì´ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    } else {
        billingDate = document.getElementById('sub-billing-date').value;
        if (!billingDate) { alert('ì—°ê°„ ê²°ì œ ê¸°ì¤€ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    }

    if (!D.subscriptions) D.subscriptions = [];

    if (_editingSubId) {
        const idx = D.subscriptions.findIndex(x => x.id === _editingSubId);
        if (idx >= 0) D.subscriptions[idx] = { ...D.subscriptions[idx], name, category, cycle, amount, billingDay, billingDate };
        _editingSubId = null;
        const btn = document.getElementById('sub-submit-btn');
        btn.textContent = '+ êµ¬ë… ì¶”ê°€';
        btn.style.background = '';
        document.getElementById('sub-form-title').textContent = 'êµ¬ë… ì„œë¹„ìŠ¤ ì¶”ê°€';
    } else {
        D.subscriptions.push({ id: uid(), name, category, cycle, amount, billingDay, billingDate, active: true });
    }

    save();
    document.getElementById('sub-name').value = '';
    document.getElementById('sub-amount').value = '';
    document.getElementById('sub-billing-day').value = '';
    document.getElementById('sub-billing-date').value = '';
    renderSubscriptions();
}

function editSubscription(id) {
    const sub = (D.subscriptions || []).find(x => x.id === id);
    if (!sub) return;
    _editingSubId = id;
    document.getElementById('sub-name').value     = sub.name;
    document.getElementById('sub-category').value = sub.category;
    document.getElementById('sub-cycle').value    = sub.cycle;
    document.getElementById('sub-amount').value   = sub.amount;
    subCycleChange();
    if (sub.cycle === 'monthly') {
        document.getElementById('sub-billing-day').value = sub.billingDay || '';
    } else {
        document.getElementById('sub-billing-date').value = sub.billingDate || '';
    }
    const btn = document.getElementById('sub-submit-btn');
    btn.textContent = 'âœï¸ ìˆ˜ì • ì™„ë£Œ';
    btn.style.background = '#f6ad55';
    document.getElementById('sub-form-title').textContent = 'êµ¬ë… ì„œë¹„ìŠ¤ ìˆ˜ì •';
    document.getElementById('tab-subscription').scrollIntoView({ behavior: 'smooth' });
}

function deleteSubscription(id) {
    if (!confirm('êµ¬ë… ì„œë¹„ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    D.subscriptions = (D.subscriptions || []).filter(x => x.id !== id);
    save(); renderSubscriptions();
}

function toggleSubscription(id) {
    const sub = (D.subscriptions || []).find(x => x.id === id);
    if (!sub) return;
    sub.active = !sub.active;
    save(); renderSubscriptions();
}

window.showTab        = showTab;
window.addSpending    = addSpending;
window.deleteSpending = deleteSpending;
window.addIncome      = addIncome;
window.editIncome     = editIncome;
window.deleteIncome   = deleteIncome;
window.addFixed       = addFixed;
window.editFixed      = editFixed;
window.deleteFixed    = deleteFixed;
window.saveSettings   = saveSettings;
window.addInterestLog    = addInterestLog;
window.deleteInterestLog = deleteInterestLog;
window.confirmIncome    = confirmIncome;
window.unconfirmIncome  = unconfirmIncome;
window.confirmFixed     = confirmFixed;
window.unconfirmFixed   = unconfirmFixed;
window.addSubscription    = addSubscription;
window.editSubscription   = editSubscription;
window.deleteSubscription = deleteSubscription;
window.toggleSubscription = toggleSubscription;
window.subCycleChange     = subCycleChange;

// â”€â”€ DOMContentLoaded â”€â”€
document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('targetDate').value    = todayStr();
    document.getElementById('log-date').value      = todayStr();
    document.getElementById('interest-date').value = todayStr();

    await Promise.all([
        jk_load(),
        loadFromFirestore().then(() => {
            renderLog(); renderIncome(); renderFixed(); renderInterestStats(); renderSubscriptions(); updateDashboard();
            document.getElementById('log-desc').addEventListener('keydown',   e => { if (e.key === 'Enter') addSpending(); });
            document.getElementById('log-amount').addEventListener('keydown', e => { if (e.key === 'Enter') addSpending(); });
        })
    ]);
});
</script>

</body></html>
