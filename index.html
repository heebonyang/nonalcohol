<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ìƒí™œ ê´€ë¦¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f3f4f6; min-height: 100vh; color: #1f2937;
            /* í•˜ë‹¨ í™ˆ ì¸ë””ì¼€ì´í„° ì˜ì—­ í™•ë³´ */
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* â”€â”€ ë©”ì¸ íƒ­ â”€â”€ */
        .main-nav {
            display: flex; background: white; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            /* ìƒë‹¨ ë…¸ì¹˜/Dynamic Island ì˜ì—­ í™•ë³´ */
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        .main-tab {
            flex: 1; padding: 16px; border: none; background: transparent;
            font-size: 1rem; font-weight: 700; color: #6b7280; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.2s;
            font-family: inherit;
        }
        .main-tab:hover { background: #f9fafb; color: #1f2937; }
        .main-tab.active { color: #0284c7; border-bottom-color: #0284c7; background: #f0f9ff; }
        .app-section { display: none; }
        .app-section.active { display: block; }

        /* â•â• ê¸ˆì£¼ ì•± CSS â•â• */
        #app-jk { padding: 30px 20px; }
        #app-jk .container { max-width: 1000px; margin: auto; }
        #app-jk .header-card {
            background: #fff; padding: 30px; border-radius: 20px;
            text-align: center; margin-bottom: 25px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        #app-jk .sub-title { font-size: 1.2rem; color: #6b7280; font-weight: 600; margin-bottom: 10px; }
        #app-jk .main-streak { font-size: 4rem; font-weight: 800; color: #0284c7; display: block; }
        #app-jk .streak-unit { font-size: 1.5rem; color: #1f2937; vertical-align: middle; }
        #app-jk .input-card {
            background: #fff; padding: 25px; border-radius: 20px;
            margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        #app-jk .form-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
        #app-jk input, #app-jk select {
            border: 1px solid #d1d5db; padding: 12px 15px;
            border-radius: 10px; font-size: 0.95rem; outline: none; font-family: inherit;
        }
        #app-jk .reason-container { width: 100%; display: none; margin-top: 15px; }
        #app-jk .reason-input { width: 100%; border: 2px solid #fecaca !important; background: #fff1f2 !important; }
        #app-jk .btn-save {
            background: #0284c7; color: white; border: none;
            padding: 12px 35px; border-radius: 10px; font-weight: 700;
            cursor: pointer; font-family: inherit;
        }
        #app-jk .btn-save.edit-mode { background: #f59e0b; }
        #app-jk .table-card {
            background: #fff; border-radius: 20px; overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        #app-jk table { width: 100%; border-collapse: collapse; }
        #app-jk th {
            background: #f9fafb; padding: 15px; color: #4b5563;
            font-size: 0.85rem; border-bottom: 1px solid #e5e7eb;
        }
        #app-jk td { padding: 18px 15px; border-bottom: 1px solid #f3f4f6; text-align: center; }
        #app-jk .status-o { color: #059669; font-weight: 800; }
        #app-jk .status-x { color: #dc2626; font-weight: 800; }
        #app-jk .reason-label { font-size: 0.8rem; color: #ef4444; display: block; margin-top: 5px; font-style: italic; }
        #app-jk .btn-edit {
            background: #e5e7eb; color: #374151; border: none;
            padding: 6px 12px; border-radius: 6px; cursor: pointer;
            margin-right: 5px; font-family: inherit;
        }
        #app-jk .btn-del {
            background: #fee2e2; color: #b91c1c; border: none;
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-family: inherit;
        }

        /* â•â• ê¸ˆì£¼ ë§ˆì¼ìŠ¤í†¤ CSS â•â• */
        #app-jk .milestone-bar {
            display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
        }
        #app-jk .milestone-chip {
            flex: 1; min-width: 120px;
            background: white; border-radius: 12px;
            padding: 10px 14px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            display: flex; align-items: center; gap: 10px;
        }
        #app-jk .milestone-chip.done {
            background: linear-gradient(135deg, #0284c7, #0ea5e9);
            color: white;
        }
        #app-jk .milestone-chip.done .mc-label,
        #app-jk .milestone-chip.done .mc-date { color: rgba(255,255,255,0.9); }
        #app-jk .mc-icon { font-size: 1.4rem; flex-shrink: 0; }
        #app-jk .mc-label { font-size: 0.72rem; color: #6b7280; font-weight: 600; margin-bottom: 2px; }
        #app-jk .mc-date  { font-size: 0.82rem; font-weight: 700; color: #1f2937; }
        #app-jk .mc-dday  { font-size: 0.7rem; font-weight: 700; margin-top: 1px; }
        #app-jk .mc-dday.soon   { color: #f59e0b; }
        #app-jk .mc-dday.future { color: #9ca3af; }
        #app-jk .mc-dday.done   { color: rgba(255,255,255,0.85); }

        /* â•â• ê°€ê³„ë¶€ ì•± CSS â•â• */
        #app-gk { padding: 16px; }
        #app-gk .container { max-width: 600px; margin: 0 auto; }
        #app-gk .dashboard {
            background: linear-gradient(135deg, #5a67d8 0%, #764ba2 100%);
            border-radius: 20px; padding: 22px; color: white;
            margin-bottom: 16px; box-shadow: 0 8px 24px rgba(90,103,216,0.35);
        }
        #app-gk .dashboard-title {
            font-size: 0.9rem; text-align: center; opacity: 0.85;
            margin-bottom: 14px; font-weight: 600;
        }
        #app-gk .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        #app-gk .stat-box { background: rgba(255,255,255,0.15); border-radius: 12px; padding: 11px 10px; text-align: center; }
        #app-gk .stat-label { font-size: 0.72rem; opacity: 0.8; margin-bottom: 4px; }
        #app-gk .stat-value { font-size: 1.1rem; font-weight: 700; }
        #app-gk .stat-value.red { color: #fbb6ce; }
        #app-gk .daily-budget-box {
            background: rgba(255,255,255,0.18); border-radius: 14px; padding: 16px;
            text-align: center; margin-bottom: 12px;
        }
        #app-gk .daily-budget-label { font-size: 0.8rem; opacity: 0.85; margin-bottom: 4px; }
        #app-gk .daily-budget-amount { font-size: 2.1rem; font-weight: 800; line-height: 1.1; }
        #app-gk .daily-budget-amount.over { color: #fbb6ce; }
        #app-gk .daily-budget-sub { font-size: 0.72rem; opacity: 0.7; margin-top: 5px; }
        #app-gk .progress-labels { display: flex; justify-content: space-between; font-size: 0.72rem; opacity: 0.82; margin-bottom: 5px; }
        #app-gk .progress-bar { height: 7px; background: rgba(255,255,255,0.25); border-radius: 999px; overflow: hidden; }
        #app-gk .progress-fill { height: 100%; background: white; border-radius: 999px; transition: width 0.6s ease; }
        #app-gk .notice {
            background: #fffbeb; border-left: 4px solid #f6ad55; border-radius: 10px;
            padding: 11px 14px; margin-bottom: 14px; font-size: 0.83rem; color: #744210;
        }
        #app-gk .notice h3 { font-size: 0.82rem; margin-bottom: 7px; color: #92400e; }
        #app-gk .notice-row { display: flex; justify-content: space-between; padding: 2px 0; }
        #app-gk .alert-banner {
            background: #fff5f5; border-left: 4px solid #fc8181; border-radius: 10px;
            padding: 10px 14px; margin-bottom: 14px; font-size: 0.83rem; color: #c53030;
        }
        #app-gk .overdraft-reminder {
            background: #ebf8ff; border-left: 4px solid #4299e1; border-radius: 10px;
            padding: 12px 14px; margin-bottom: 14px; font-size: 0.83rem; color: #2b6cb0;
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        #app-gk .overdraft-reminder-text { flex: 1; }
        #app-gk .overdraft-reminder-btn {
            background: #4299e1; color: #fff; border: none; border-radius: 7px;
            padding: 5px 12px; font-size: 0.78rem; font-weight: 700;
            cursor: pointer; white-space: nowrap; font-family: inherit;
        }
        #app-gk .overdraft-reminder-btn:hover { background: #3182ce; }
        #app-gk .gk-tabs { display: flex; gap: 8px; margin-bottom: 14px; overflow-x: auto; }
        #app-gk .gk-tab {
            padding: 8px 18px; border-radius: 999px; border: none; cursor: pointer;
            font-size: 0.83rem; font-weight: 600; white-space: nowrap;
            transition: background 0.2s; font-family: inherit;
        }
        #app-gk .gk-tab.active { background: #5a67d8; color: white; }
        #app-gk .gk-tab:not(.active) { background: white; color: #4a5568; }
        #app-gk .gk-tab:not(.active):hover { background: #e2e8f0; }
        #app-gk .card {
            background: white; border-radius: 14px; padding: 18px;
            margin-bottom: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        #app-gk .card h2 { font-size: 0.95rem; color: #4a5568; margin-bottom: 14px; font-weight: 700; }
        #app-gk .form-group { margin-bottom: 12px; }
        #app-gk .form-group label { display: block; font-size: 0.75rem; color: #718096; margin-bottom: 5px; font-weight: 600; }
        #app-gk .form-group input, #app-gk .form-group select {
            width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0;
            border-radius: 8px; font-size: 0.92rem; background: white; font-family: inherit;
        }
        #app-gk .form-group input:focus, #app-gk .form-group select:focus {
            outline: none; border-color: #5a67d8;
        }
        #app-gk .gk-row { display: flex; gap: 10px; }
        #app-gk .gk-row .form-group { flex: 1; min-width: 0; }
        #app-gk .btn {
            padding: 11px 18px; border: none; border-radius: 9px; cursor: pointer;
            font-size: 0.9rem; font-weight: 700; width: 100%;
            transition: opacity 0.2s; font-family: inherit;
        }
        #app-gk .btn:hover { opacity: 0.88; }
        #app-gk .btn-primary { background: #5a67d8; color: white; }
        #app-gk .btn-success { background: #48bb78; color: white; }
        #app-gk .btn-sm {
            font-size: 0.72rem; padding: 4px 10px; width: auto; border-radius: 999px;
            background: #fed7d7; color: #c53030; border: none; cursor: pointer;
            font-weight: 600; font-family: inherit;
        }
        #app-gk .btn-sm:hover { background: #fc8181; color: white; }
        #app-gk .btn-sm-edit {
            font-size: 0.72rem; padding: 4px 10px; width: auto; border-radius: 999px;
            background: #bee3f8; color: #2b6cb0; border: none; cursor: pointer;
            font-weight: 600; font-family: inherit;
        }
        #app-gk .btn-sm-edit:hover { background: #63b3ed; color: white; }
        #app-gk .btn-sm-confirm {
            font-size: 0.72rem; padding: 4px 10px; width: auto; border-radius: 999px;
            background: #c6f6d5; color: #276749; border: none; cursor: pointer;
            font-weight: 600; font-family: inherit;
        }
        #app-gk .btn-sm-confirm:hover { background: #48bb78; color: white; }
        #app-gk .btn-sm-unconfirm {
            font-size: 0.72rem; padding: 4px 10px; width: auto; border-radius: 999px;
            background: #e2e8f0; color: #718096; border: none; cursor: pointer;
            font-weight: 600; font-family: inherit;
        }
        #app-gk .btn-sm-unconfirm:hover { background: #a0aec0; color: white; }
        #app-gk .list-item { display: flex; justify-content: space-between; align-items: center; padding: 11px 0; border-bottom: 1px solid #f0f4f8; }
        #app-gk .list-item:last-child { border-bottom: none; }
        #app-gk .list-item .info .name { font-weight: 600; font-size: 0.92rem; }
        #app-gk .list-item .info .sub { font-size: 0.77rem; color: #a0aec0; margin-top: 2px; }
        #app-gk .list-item .right { display: flex; align-items: center; gap: 10px; }
        #app-gk .list-item .amount { font-weight: 700; color: #e53e3e; font-size: 0.95rem; }
        #app-gk .empty { text-align: center; color: #a0aec0; padding: 20px; font-size: 0.87rem; }
        #app-gk .info-box { background: #ebf4ff; border-radius: 10px; padding: 14px; font-size: 0.8rem; color: #2b6cb0; line-height: 1.7; }
        #app-gk .info-box p + p { margin-top: 4px; }
        #app-gk .divider { height: 1px; background: #f0f4f8; margin: 10px 0; }

        /* â•â• êµ¬ë… ê´€ë¦¬ CSS â•â• */
        #app-gk .sub-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 4px; }
        #app-gk .sub-summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px; padding: 12px 8px; color: white; text-align: center;
        }
        #app-gk .sub-summary-label { font-size: 0.68rem; opacity: 0.85; margin-bottom: 4px; }
        #app-gk .sub-summary-value { font-size: 0.95rem; font-weight: 700; }
        #app-gk .sub-badge {
            font-size: 0.65rem; padding: 2px 6px; border-radius: 999px;
            font-weight: 600; vertical-align: middle; margin-left: 3px;
        }
        #app-gk .sub-badge-monthly { background: #ebf4ff; color: #2b6cb0; }
        #app-gk .sub-badge-yearly  { background: #fefcbf; color: #744210; }
        #app-gk .sub-toggle { position: relative; display: inline-block; width: 36px; height: 20px; cursor: pointer; flex-shrink: 0; }
        #app-gk .sub-toggle input { opacity: 0; width: 0; height: 0; }
        #app-gk .sub-toggle-slider {
            position: absolute; inset: 0; background: #e2e8f0;
            border-radius: 999px; transition: 0.2s;
        }
        #app-gk .sub-toggle-slider:before {
            content: ''; position: absolute; width: 14px; height: 14px;
            background: white; border-radius: 50%; top: 3px; left: 3px; transition: 0.2s;
        }
        #app-gk .sub-toggle input:checked + .sub-toggle-slider { background: #5a67d8; }
        #app-gk .sub-toggle input:checked + .sub-toggle-slider:before { transform: translateX(16px); }
        #app-gk .sub-inactive { opacity: 0.4; }
        #app-gk .sub-next-date { font-size: 0.72rem; color: #a0aec0; margin-top: 2px; }
        #app-gk .sub-next-date.soon { color: #e53e3e; font-weight: 600; }
        #app-gk .sub-item-inner { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }

        /* â•â• ëŒ€ì¶œ ê´€ë¦¬ CSS â•â• */
        #app-gk .loan-summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 4px; }
        #app-gk .loan-summary-box {
            background: linear-gradient(135deg, #e53e3e 0%, #c05621 100%);
            border-radius: 12px; padding: 12px 8px; color: white; text-align: center;
        }
        #app-gk .loan-summary-label { font-size: 0.68rem; opacity: 0.85; margin-bottom: 4px; }
        #app-gk .loan-summary-value { font-size: 0.95rem; font-weight: 700; }
        #app-gk .loan-card {
            background: #fff8f8; border: 1.5px solid #fed7d7;
            border-radius: 12px; padding: 14px; margin-bottom: 10px;
        }
        #app-gk .loan-card:last-child { margin-bottom: 0; }
        #app-gk .loan-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        #app-gk .loan-card-name { font-size: 0.95rem; font-weight: 700; color: #2d3748; }
        #app-gk .loan-card-memo { font-size: 0.72rem; color: #a0aec0; margin-top: 2px; }
        #app-gk .loan-meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
        #app-gk .loan-meta-item { background: white; border-radius: 8px; padding: 8px 10px; }
        #app-gk .loan-meta-label { font-size: 0.68rem; color: #718096; margin-bottom: 2px; }
        #app-gk .loan-meta-value { font-size: 0.88rem; font-weight: 700; color: #2d3748; }
        #app-gk .loan-next-pay { font-size: 0.77rem; color: #c53030; font-weight: 600; margin-bottom: 10px; }
        #app-gk .loan-next-pay.far { color: #718096; font-weight: 400; }
        #app-gk .btn-schedule-pay { background: #ebf8ff; color: #2b6cb0; border: none; border-radius: 6px; padding: 3px 8px; font-size: 0.72rem; font-weight: 700; cursor: pointer; font-family: inherit; white-space: nowrap; }
        #app-gk .btn-schedule-pay:hover { background: #bee3f8; }
        #app-gk .pay-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f4f8; }
        #app-gk .pay-item:last-child { border-bottom: none; }
        #app-gk .pay-item-date { font-size: 0.8rem; font-weight: 600; color: #4a5568; }
        #app-gk .pay-item-detail { font-size: 0.72rem; color: #a0aec0; margin-top: 1px; }
        #app-gk .pay-item-amount { font-size: 0.88rem; font-weight: 700; color: #e53e3e; }

        /* â•â• ëŒ€ì¶œ ê³„ì‚° ë¯¸ë¦¬ë³´ê¸° CSS â•â• */
        #app-gk .loan-calc-preview {
            background: #f0fff4; border: 1.5px solid #9ae6b4;
            border-radius: 10px; padding: 12px 14px; margin: 10px 0;
        }
        #app-gk .loan-preview-title { font-size: 0.8rem; font-weight: 700; color: #276749; margin-bottom: 8px; }
        #app-gk .loan-preview-row {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.8rem; padding: 3px 0; border-bottom: 1px solid #c6f6d5;
        }
        #app-gk .loan-preview-row:last-child { border-bottom: none; }
        #app-gk .loan-preview-label { color: #4a5568; }
        #app-gk .loan-preview-val { font-weight: 700; color: #2d3748; }
        #app-gk .loan-preview-val.red { color: #e53e3e; }
        #app-gk .loan-preview-sub { font-size: 0.72rem; color: #718096; }
        #app-gk .loan-grace-row td { background: #fefcbf !important; color: #744210; }

        /* â•â• ìƒí™˜ ì¼ì • CSS â•â• */
        #app-gk .loan-repay-badge {
            font-size: 0.67rem; padding: 2px 7px; border-radius: 999px;
            font-weight: 600; background: #fef3c7; color: #92400e; margin-left: 5px;
            vertical-align: middle;
        }
        #app-gk .loan-pred-box {
            background: #fff5f5; border: 1px solid #fed7d7;
            border-radius: 10px; padding: 11px 13px; margin: 8px 0;
            font-size: 0.8rem; line-height: 2;
        }
        #app-gk .loan-pred-row { display: flex; justify-content: space-between; align-items: center; }
        #app-gk .loan-pred-label { color: #718096; }
        #app-gk .btn-toggle-schedule {
            font-size: 0.75rem; padding: 5px 12px;
            background: #edf2f7; border: none; border-radius: 6px;
            cursor: pointer; color: #4a5568; font-family: inherit;
            font-weight: 600; width: 100%; margin-top: 4px;
        }
        #app-gk .btn-toggle-schedule:hover { background: #e2e8f0; }
        #app-gk .loan-schedule-wrap { display: none; overflow-x: auto; margin-top: 8px; }
        #app-gk .loan-schedule-wrap.open { display: block; }
        #app-gk .loan-schedule-table {
            width: 100%; border-collapse: collapse;
            font-size: 0.74rem; min-width: 320px;
        }
        #app-gk .loan-schedule-table th {
            background: #f7fafc; padding: 6px 8px; color: #718096;
            font-size: 0.68rem; border-bottom: 1px solid #e2e8f0;
            text-align: right; white-space: nowrap;
        }
        #app-gk .loan-schedule-table th:first-child { text-align: left; }
        #app-gk .loan-schedule-table td {
            padding: 5px 8px; border-bottom: 1px solid #f0f4f8;
            text-align: right; color: #4a5568;
        }
        #app-gk .loan-schedule-table td:first-child { text-align: left; color: #718096; font-weight: 600; }
        #app-gk .loan-schedule-table tr:last-child td { border-bottom: none; }
        #app-gk .loan-schedule-table .col-payment { font-weight: 700; color: #2d3748; }
        #app-gk .loan-schedule-table .col-balance { color: #a0aec0; }
        #app-gk .loan-schedule-table .col-interest { color: #e53e3e; }

        /* â•â• ëª¨ë°”ì¼ ë°˜ì‘í˜• â•â• */
        @media (max-width: 600px) {
            /* íƒ­: ì¢Œìš° safe-area íŒ¨ë”© í¬í•¨ */
            .main-tab {
                padding: 13px 8px; font-size: 0.88rem;
            }

            /* ê¸ˆì£¼ ì•± */
            #app-jk {
                padding: 14px 12px;
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
                overflow-x: hidden;
            }
            #app-jk .container { width: 100%; }
            /* ë§ˆì¼ìŠ¤í†¤ ì¹© min-width í•´ì œ â†’ 3ê°œê°€ í™”ë©´ì„ ë„˜ì¹˜ëŠ” ì›ì¸ */
            #app-jk .milestone-chip { min-width: 0; }
            #app-jk .header-card { padding: 20px 16px; margin-bottom: 14px; }
            #app-jk .sub-title { font-size: 1rem; }
            #app-jk .main-streak { font-size: 3rem; }
            #app-jk .streak-unit { font-size: 1.2rem; }
            #app-jk .input-card { padding: 16px 14px; margin-bottom: 14px; overflow: hidden; }

            /* í¼: 2ì—´ ê·¸ë¦¬ë“œë¡œ ì „í™˜ */
            #app-jk .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                overflow: hidden;
            }
            /* ë‚ ì§œÂ·ìŠ¤í¬ë¦°Â·AIÂ·ì €ì¥ ë²„íŠ¼ì€ ì „ì²´ ë„ˆë¹„ */
            #app-jk #targetDate,
            #app-jk #screen,
            #app-jk #ai { grid-column: 1 / -1; width: 100%; }
            #app-jk .btn-save {
                grid-column: 1 / -1; width: 100%;
                padding: 14px; font-size: 1rem;
            }
            /* iOS Safari ìë™ ì¤Œ ë°©ì§€ + ê·¸ë¦¬ë“œ ì…€ ë„˜ì¹¨ ë°©ì§€ */
            #app-jk input, #app-jk select { font-size: 16px; width: 100%; min-width: 0; }

            /* í…Œì´ë¸”: ê°€ë¡œ ìŠ¤í¬ë¡¤ */
            #app-jk .table-card { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 16px; }
            #app-jk table { min-width: 500px; }
            #app-jk th { padding: 11px 8px; font-size: 0.78rem; }
            #app-jk td { padding: 13px 8px; font-size: 0.84rem; }
            #app-jk .btn-edit,
            #app-jk .btn-del { padding: 5px 8px; font-size: 0.78rem; }
            #app-jk .btn-edit { margin-right: 3px; }

            /* ê°€ê³„ë¶€ ì•± */
            #app-gk {
                padding: 12px;
                padding-left: max(12px, env(safe-area-inset-left));
                padding-right: max(12px, env(safe-area-inset-right));
            }
            #app-gk .dashboard { padding: 16px; border-radius: 16px; }
            #app-gk .daily-budget-amount { font-size: 1.8rem; }
            #app-gk .card { padding: 14px; }
            /* iOS Safari ìë™ ì¤Œ ë°©ì§€ */
            #app-gk .form-group input,
            #app-gk .form-group select,
            #app-gk .form-group input[type="month"] { font-size: 16px; }

            /* êµ¬ë…/ëŒ€ì¶œ ìš”ì•½ ê·¸ë¦¬ë“œ: ì¢ì€ í™”ë©´ì—ì„œ 2ì—´ ìœ ì§€ */
            #app-gk .sub-summary-grid,
            #app-gk .loan-summary-grid { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            #app-gk .sub-summary-label,
            #app-gk .loan-summary-label { font-size: 0.62rem; }
            #app-gk .sub-summary-value,
            #app-gk .loan-summary-value { font-size: 0.85rem; }
        }

        /* â•â• iPhone SE (375px) ë“± ì´ˆì†Œí˜• í™”ë©´ â•â• */
        @media (max-width: 390px) {
            .main-tab { font-size: 0.8rem; padding: 11px 5px; }
            #app-jk .main-streak { font-size: 2.5rem; }
            #app-jk .milestone-chip { min-width: 100px; padding: 8px 10px; }
            #app-jk .mc-icon { font-size: 1.2rem; }
            #app-gk .stats-grid { gap: 7px; }
            #app-gk .stat-value { font-size: 1rem; }
            #app-gk .daily-budget-amount { font-size: 1.6rem; }
            #app-gk .gk-tab { padding: 7px 12px; font-size: 0.78rem; }
        }
    </style>
</head>
<body>

<!-- â•â• ë©”ì¸ íƒ­ ë‚´ë¹„ê²Œì´ì…˜ â•â• -->
<nav class="main-nav">
    <button class="main-tab active" onclick="switchApp('jk', this)">ğŸº ê¸ˆì£¼ 100ì¼</button>
    <button class="main-tab" onclick="switchApp('gk', this)">ğŸ’° D-Day ê°€ê³„ë¶€</button>
</nav>

<!-- â•â• ê¸ˆì£¼ ì•± â•â• -->
<div id="app-jk" class="app-section active">
    <div class="container">
        <div class="header-card">
            <div class="sub-title">ê¸ˆì£¼ 100ì¼ í”„ë¡œì íŠ¸</div>
            <div>
                <span class="main-streak" id="day-count">0</span>
                <span class="streak-unit" id="streak-text">ì¼ì°¨ ê¸ˆì£¼ ì¤‘</span>
            </div>
        </div>
        <div class="milestone-bar" id="jk-milestones"></div>
        <div class="input-card">
            <div class="form-grid">
                <input type="date" id="targetDate" onchange="jk_resetInputs()">
                <select id="sober" onchange="jk_toggleReason()">
                    <option value="O">ê¸ˆì£¼ ì„±ê³µ O</option>
                    <option value="X">ê¸ˆì£¼ ì‹¤íŒ¨ X</option>
                </select>
                <select id="exercise">
                    <option value="O">ìš´ë™ O</option>
                    <option value="X">ìš´ë™ X</option>
                </select>
                <input type="text" id="screen" placeholder="ìŠ¤í¬ë¦° íƒ€ì„">
                <input type="text" id="ai" placeholder="AI ê³µë¶€ ë‚´ìš©">
                <button class="btn-save" id="save-btn" onclick="jk_addRecord()">ê¸°ë¡í•˜ê¸°</button>
            </div>
            <div class="reason-container" id="reason-container">
                <input type="text" id="reason" class="reason-input" placeholder="ì‹¤íŒ¨ ì›ì¸ì„ ê¸°ë¡í•˜ì„¸ìš”">
            </div>
        </div>
        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th><th>ê¸ˆì£¼ ì—¬ë¶€</th><th>ìš´ë™</th>
                        <th>ìŠ¤í¬ë¦° íƒ€ì„</th><th>AI ê³µë¶€ ë‚´ìš©</th><th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="data-list"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- â•â• ê°€ê³„ë¶€ ì•± â•â• -->
<div id="app-gk" class="app-section">
    <div class="container">
        <div class="dashboard">
            <div class="dashboard-title" id="dash-title">ğŸ¯ ëª©í‘œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">ë‚¨ì€ ë‚ ì§œ</div><div class="stat-value" id="dash-dday">D-?</div></div>
                <div class="stat-box"><div class="stat-label">ë‹¬ì„±ë¥ </div><div class="stat-value" id="dash-pct">0%</div></div>
                <div class="stat-box"><div class="stat-label">í˜„ì¬ ì”ì•¡</div><div class="stat-value" id="dash-balance">-</div></div>
                <div class="stat-box"><div class="stat-label">ì˜¤ëŠ˜ê¹Œì§€ ì§€ì¶œ</div><div class="stat-value red" id="dash-month-spent">-</div></div>
            </div>
            <div class="daily-budget-box">
                <div class="daily-budget-label">ì˜¤ëŠ˜ ë‚¨ì€ ì§€ì¶œ ê°€ëŠ¥ì•¡</div>
                <div class="daily-budget-amount" id="dash-today-remain">ì„¤ì • í•„ìš”</div>
                <div class="daily-budget-sub" id="dash-today-sub"></div>
            </div>
            <div class="progress-labels">
                <span id="dash-saved-label">ì €ì¶• 0ì›</span>
                <span id="dash-goal-label">ëª©í‘œ 5,000,000ì›</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="dash-progress" style="width:0%"></div>
            </div>
        </div>

        <div class="notice" id="notice-upcoming" style="display:none">
            <h3>ğŸ“… ì•ìœ¼ë¡œ 7ì¼ ë‚´ ì˜ˆì • ê±°ë˜</h3>
            <div id="notice-list"></div>
        </div>
        <div class="alert-banner" id="alert-over" style="display:none">
            âš ï¸ ì˜¤ëŠ˜ ì§€ì¶œ ê°€ëŠ¥ì•¡ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‚´ì¼ë¶€í„° ë” ì•„ê»´ì•¼ ëª©í‘œë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆì–´ìš”.
        </div>
        <div class="alert-banner" id="alert-pending" style="display:none">
            âš ï¸ ì˜ˆì •ì¼ì´ ì§€ë‚œ ë¯¸í™•ì¸ í•­ëª©ì´ <span id="alert-pending-count">0</span>ê±´ ìˆìŠµë‹ˆë‹¤. ì‹¤ì œ ê¸ˆì•¡ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.
        </div>
        <div class="overdraft-reminder" id="alert-overdraft-reminder" style="display:none">
            <div class="overdraft-reminder-text">
                ğŸ¦ <strong>ì›”ë§ ì•Œë¦¼</strong> â€” ë§ˆì´ë„ˆìŠ¤ í†µì¥ ì”ì•¡ì„ ìµœì‹ ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•´ ì£¼ì„¸ìš”.<br>
                <span style="font-size:0.75rem;opacity:0.8;">ëŒ€ì¶œ íƒ­ â†’ ë§ˆì´ë„ˆìŠ¤ í†µì¥ í•­ëª© ìˆ˜ì •</span>
            </div>
            <button class="overdraft-reminder-btn" onclick="dismissOverdraftReminder()">í™•ì¸</button>
        </div>

        <div class="gk-tabs">
            <button class="gk-tab active" onclick="showTab('log')">ğŸ“ ì§€ì¶œ ê¸°ë¡</button>
            <button class="gk-tab" onclick="showTab('income')">ğŸ’° ì˜ˆì • ìˆ˜ì…</button>
            <button class="gk-tab" onclick="showTab('fixed')">ğŸ”’ ì˜ˆì • ê³ ì •ë¹„</button>
            <button class="gk-tab" onclick="showTab('subscription')">ğŸ“± êµ¬ë…</button>
            <button class="gk-tab" onclick="showTab('loan')">ğŸ¦ ëŒ€ì¶œ</button>
            <button class="gk-tab" onclick="showTab('settings')">âš™ï¸ ì„¤ì •</button>
        </div>

        <div id="tab-log">
            <div class="card">
                <h2>ì§€ì¶œ ì¶”ê°€</h2>
                <div class="gk-row">
                    <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="log-date"></div>
                    <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="number" id="log-amount" placeholder="0" min="0"></div>
                </div>
                <div class="form-group"><label>ë‚´ìš©</label><input type="text" id="log-desc" placeholder="ì˜ˆ: í¸ì˜ì , ì ì‹¬ì‹ì‚¬"></div>
                <button class="btn btn-primary" onclick="addSpending()">+ ì§€ì¶œ ì¶”ê°€</button>
            </div>
            <div class="card">
                <h2>ì§€ì¶œ ë‚´ì—­</h2>
                <div id="log-list"><div class="empty">ì•„ì§ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>

        <div id="tab-income" style="display:none">
            <div class="card">
                <h2>ì˜ˆì • ìˆ˜ì… ì¶”ê°€</h2>
                <div class="form-group"><label>í•­ëª©ëª…</label><input type="text" id="income-name" placeholder="ì˜ˆ: ì›”ê¸‰, ë³´ë„ˆìŠ¤, ì´ì ìˆ˜ì…"></div>
                <div class="gk-row">
                    <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="number" id="income-amount" placeholder="0" min="0"></div>
                    <div class="form-group"><label>ìˆ˜ì… ì˜ˆì •ì¼</label><input type="date" id="income-date"></div>
                </div>
                <button class="btn btn-success" id="income-submit-btn" onclick="addIncome()">+ ìˆ˜ì… ë“±ë¡</button>
            </div>
            <div class="card">
                <h2>ë“±ë¡ëœ ì˜ˆì • ìˆ˜ì…</h2>
                <div id="income-list"><div class="empty">ë“±ë¡ëœ ì˜ˆì • ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
                <div id="income-total-wrap" style="display:none">
                    <div class="divider"></div>
                    <div style="display:flex;justify-content:space-between;font-size:0.85rem;font-weight:700;color:#4a5568;padding-top:8px;">
                        <span>ì˜ˆì • ìˆ˜ì… í•©ê³„</span>
                        <span id="income-total-amount" style="color:#48bb78;"></span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-fixed" style="display:none">
            <div class="card">
                <h2>ì˜ˆì • ê³ ì •ë¹„ ì¶”ê°€</h2>
                <div class="form-group"><label>í•­ëª©ëª…</label><input type="text" id="fixed-name" placeholder="ì˜ˆ: ì›”ì„¸, ì´ì, ë³´í—˜ë£Œ"></div>
                <div class="gk-row">
                    <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="number" id="fixed-amount" placeholder="0" min="0"></div>
                    <div class="form-group"><label>ì§€ì¶œ ì˜ˆì •ì¼</label><input type="date" id="fixed-date"></div>
                </div>
                <button class="btn btn-primary" id="fixed-submit-btn" onclick="addFixed()">+ ê³ ì •ë¹„ ë“±ë¡</button>
            </div>
            <div class="card">
                <h2>ë“±ë¡ëœ ì˜ˆì • ê³ ì •ë¹„</h2>
                <div id="fixed-list"><div class="empty">ë“±ë¡ëœ ê³ ì •ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>
                <div id="fixed-total-wrap" style="display:none">
                    <div class="divider"></div>
                    <div style="display:flex;justify-content:space-between;font-size:0.85rem;font-weight:700;color:#4a5568;padding-top:8px;">
                        <span>ì˜ˆì • ê³ ì •ë¹„ í•©ê³„</span>
                        <span id="fixed-total-amount" style="color:#e53e3e;"></span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-loan" style="display:none">
            <!-- ëŒ€ì¶œ í˜„í™© ìš”ì•½ -->
            <div class="card" id="loan-summary-card" style="display:none">
                <h2>ëŒ€ì¶œ í˜„í™©</h2>
                <div class="loan-summary-grid">
                    <div class="loan-summary-box">
                        <div class="loan-summary-label">ì´ ì”ì—¬ ëŒ€ì¶œê¸ˆ</div>
                        <div class="loan-summary-value" id="loan-total-balance">0ì›</div>
                    </div>
                    <div class="loan-summary-box">
                        <div class="loan-summary-label">ì›” ë‚©ë¶€ í•©ê³„</div>
                        <div class="loan-summary-value" id="loan-monthly-sum">0ì›</div>
                    </div>
                    <div class="loan-summary-box">
                        <div class="loan-summary-label">ëŒ€ì¶œ ê±´ìˆ˜</div>
                        <div class="loan-summary-value" id="loan-count">0ê±´</div>
                    </div>
                </div>
            </div>

            <!-- ëŒ€ì¶œ ì¶”ê°€/ìˆ˜ì • í¼ -->
            <div class="card">
                <h2 id="loan-form-title">ëŒ€ì¶œ ì¶”ê°€</h2>
                <div class="form-group">
                    <label>ëŒ€ì¶œëª…</label>
                    <input type="text" id="loan-name" placeholder="ì˜ˆ: ì£¼íƒë‹´ë³´ëŒ€ì¶œ, ì „ì„¸ìê¸ˆëŒ€ì¶œ">
                </div>
                <div class="gk-row">
                    <div class="form-group">
                        <label id="loan-balance-label">ëŒ€ì¶œ ì›ê¸ˆ / ì”ì—¬ê¸ˆ (ì›)</label>
                        <input type="number" id="loan-balance" placeholder="0" min="0" oninput="autoCalcLoanPayment()">
                    </div>
                    <div class="form-group">
                        <label>ì—° ê¸ˆë¦¬ (%)</label>
                        <input type="number" id="loan-rate" placeholder="3.5" min="0" step="0.01" oninput="autoCalcLoanPayment()">
                    </div>
                </div>
                <div class="gk-row">
                    <div class="form-group">
                        <label>ìƒí™˜ ë°©ì‹</label>
                        <select id="loan-repay-type" onchange="loanRepayTypeChange()">
                            <option value="">ì„ íƒ ì•ˆ í•¨</option>
                            <option value="annuity">ì›ë¦¬ê¸ˆê· ë“±ìƒí™˜</option>
                            <option value="principal_equal">ì›ê¸ˆê· ë“±ìƒí™˜</option>
                            <option value="overdraft">ë§ˆì´ë„ˆìŠ¤ í†µì¥</option>
                        </select>
                    </div>
                    <div class="form-group" id="loan-grace-group">
                        <label>ê±°ì¹˜ê¸°í•œ (ì´ìë§Œ ë‚©ë¶€ ì¢…ë£Œì¼)</label>
                        <input type="date" id="loan-grace-date" oninput="autoCalcLoanPayment()">
                    </div>
                </div>
                <div class="gk-row" id="loan-end-group">
                    <div class="form-group">
                        <label>ëŒ€ì¶œê¸°í•œ (ìµœì¢… ìƒí™˜ì¼)</label>
                        <input type="date" id="loan-end-date" oninput="autoCalcLoanPayment()">
                    </div>
                    <div class="form-group">
                        <label>ë§¤ì›” ë‚©ë¶€ì¼ (ì¼)</label>
                        <input type="number" id="loan-payday" placeholder="25" min="1" max="31">
                    </div>
                </div>
                <div class="gk-row" id="loan-overdraft-group" style="display:none">
                    <div class="form-group">
                        <label>í•œë„ (ì›, ì„ íƒ)</label>
                        <input type="number" id="loan-limit" placeholder="ì˜ˆ: 50000000" min="0">
                    </div>
                    <div class="form-group">
                        <label>ë§¤ì›” ì´ì ë‚©ë¶€ì¼ (ì¼)</label>
                        <input type="number" id="loan-payday-od" placeholder="25" min="1" max="31" oninput="syncOverdraftPayday()">
                    </div>
                </div>
                <!-- ìë™ ê³„ì‚° ë¯¸ë¦¬ë³´ê¸° -->
                <div id="loan-calc-preview" class="loan-calc-preview" style="display:none">
                    <div class="loan-preview-title">ğŸ“Š ì˜ˆìƒ ë‚©ë¶€ ì •ë³´</div>
                    <div id="loan-preview-body"></div>
                </div>
                <input type="hidden" id="loan-monthly">
                <div class="form-group">
                    <label>ë©”ëª¨ (ì„ íƒ)</label>
                    <input type="text" id="loan-memo" placeholder="ì˜ˆ: 2028ë…„ 12ì›” ë§Œê¸°">
                </div>
                <button class="btn btn-primary" id="loan-submit-btn" onclick="addLoan()">+ ëŒ€ì¶œ ì¶”ê°€</button>
            </div>

            <!-- ëŒ€ì¶œ ëª©ë¡ -->
            <div class="card">
                <h2>ë“±ë¡ëœ ëŒ€ì¶œ</h2>
                <div id="loan-list"><div class="empty">ë“±ë¡ëœ ëŒ€ì¶œì´ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>

        </div>

        <div id="tab-subscription" style="display:none">
            <div class="card" id="sub-summary-card" style="display:none">
                <h2>êµ¬ë… ìš”ì•½</h2>
                <div class="sub-summary-grid">
                    <div class="sub-summary-box">
                        <div class="sub-summary-label">ì›” ì˜ˆìƒ ì§€ì¶œ</div>
                        <div class="sub-summary-value" id="sub-monthly-total">0ì›</div>
                    </div>
                    <div class="sub-summary-box">
                        <div class="sub-summary-label">ì—°ê°„ ì´ì•¡</div>
                        <div class="sub-summary-value" id="sub-yearly-total">0ì›</div>
                    </div>
                    <div class="sub-summary-box">
                        <div class="sub-summary-label">í™œì„± êµ¬ë…</div>
                        <div class="sub-summary-value" id="sub-active-count">0ê°œ</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2 id="sub-form-title">êµ¬ë… ì„œë¹„ìŠ¤ ì¶”ê°€</h2>
                <div class="form-group">
                    <label>ì„œë¹„ìŠ¤ëª…</label>
                    <input type="text" id="sub-name" placeholder="ì˜ˆ: Netflix, ìœ íŠœë¸Œ í”„ë¦¬ë¯¸ì—„">
                </div>
                <div class="gk-row">
                    <div class="form-group">
                        <label>ì¹´í…Œê³ ë¦¬</label>
                        <select id="sub-category">
                            <option value="streaming">ğŸ“º ìŠ¤íŠ¸ë¦¬ë°</option>
                            <option value="music">ğŸµ ìŒì•…</option>
                            <option value="software">ğŸ’» ì†Œí”„íŠ¸ì›¨ì–´</option>
                            <option value="game">ğŸ® ê²Œì„</option>
                            <option value="cloud">â˜ï¸ í´ë¼ìš°ë“œ</option>
                            <option value="food">ğŸ” ìŒì‹/ë°°ë‹¬</option>
                            <option value="shopping">ğŸ›’ ì‡¼í•‘</option>
                            <option value="fitness">ğŸ‹ï¸ í”¼íŠ¸ë‹ˆìŠ¤</option>
                            <option value="education">ğŸ“š êµìœ¡</option>
                            <option value="etc">ğŸŒ ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê²°ì œ ì£¼ê¸°</label>
                        <select id="sub-cycle" onchange="subCycleChange()">
                            <option value="monthly">ë§¤ì›”</option>
                            <option value="yearly">ë§¤ë…„</option>
                        </select>
                    </div>
                </div>
                <div class="gk-row">
                    <div class="form-group">
                        <label>ê¸ˆì•¡ (ì›)</label>
                        <input type="number" id="sub-amount" placeholder="0" min="0">
                    </div>
                    <div class="form-group" id="sub-billing-day-wrap">
                        <label>ë§¤ì›” ê²°ì œì¼ (ì¼)</label>
                        <input type="number" id="sub-billing-day" placeholder="15" min="1" max="31">
                    </div>
                    <div class="form-group" id="sub-billing-date-wrap" style="display:none">
                        <label>ì—°ê°„ ê²°ì œ ê¸°ì¤€ì¼</label>
                        <input type="date" id="sub-billing-date">
                    </div>
                </div>
                <button class="btn btn-primary" id="sub-submit-btn" onclick="addSubscription()">+ êµ¬ë… ì¶”ê°€</button>
            </div>
            <div class="card">
                <h2>ë“±ë¡ëœ êµ¬ë… ì„œë¹„ìŠ¤</h2>
                <div id="sub-list"><div class="empty">ë“±ë¡ëœ êµ¬ë… ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>
            </div>
        </div>

        <div id="tab-settings" style="display:none">
            <div class="card">
                <h2>âš™ï¸ ê¸°ë³¸ ì„¤ì •</h2>
                <div class="form-group"><label>ëª©í‘œ ê¸ˆì•¡ (ì›)</label><input type="number" id="s-goal" placeholder="5000000"></div>
                <div class="form-group"><label>ëª©í‘œ ë‚ ì§œ</label><input type="date" id="s-target"></div>
                <div class="divider"></div>
                <div class="form-group"><label>í˜„ì¬ ì”ì•¡ (ì›)</label><input type="number" id="s-balance" placeholder="0"></div>
                <div class="divider"></div>
                <div class="form-group"><label>ë¹„ìƒê¸ˆ ì˜ˆë¹„ (ì›)</label><input type="number" id="s-emergency" placeholder="1000000"></div>
                <button class="btn btn-success" onclick="saveSettings()">ì €ì¥</button>
            </div>
            <div class="card">
                <div class="info-box">
                    <p>ğŸ’¡ <strong>ì¼ì¼ ì§€ì¶œ ê°€ëŠ¥ì•¡ ê³„ì‚° ë°©ì‹</strong></p>
                    <p>í˜„ì¬ì”ì•¡ + ëª©í‘œì¼ ì „ ì˜ˆì • ìˆ˜ì… âˆ’ ëª©í‘œì¼ ì „ ì˜ˆì • ê³ ì •ë¹„ âˆ’ ëª©í‘œì¼ ì „ í™œì„± êµ¬ë…ë£Œ âˆ’ ëª©í‘œê¸ˆì•¡ âˆ’ ë¹„ìƒê¸ˆ = ì•ìœ¼ë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì´ ê¸ˆì•¡</p>
                    <p style="margin-top:6px;">ì´ ê°€ìš©ê¸ˆì•¡ âˆ’ ì´ë¯¸ ê¸°ë¡í•œ ì§€ì¶œ = ë‚¨ì€ ê°€ìš©ê¸ˆì•¡ Ã· ë‚¨ì€ ë‚ ìˆ˜ = <strong>ì˜¤ëŠ˜ ê¶Œì¥ ì§€ì¶œ</strong></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyCE7iN5FD2d8HegeNx0BQt6Af935k4_yjI",
    authDomain: "nonalcohol-f1fe7.firebaseapp.com",
    projectId: "nonalcohol-f1fe7",
    storageBucket: "nonalcohol-f1fe7.firebasestorage.app",
    messagingSenderId: "429464917450",
    appId: "1:429464917450:web:a6304e8624a5a336bfeb33"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// â”€â”€ ê³µí†µ ìœ í‹¸ â”€â”€
function todayStr() {
    const t = new Date();
    return `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;
}
function fmtDate(d) {
    const dt = (typeof d === 'string') ? new Date(d) : d;
    return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
}
function pad(n) { return String(n).padStart(2, '0'); }
function fmtMoney(n) { return Math.round(n).toLocaleString('ko-KR') + 'ì›'; }
function fmtYearMonth(dateStr) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    return `${d.getFullYear()}ë…„ ${d.getMonth()+1}ì›”`;
}
function monthDiff(from, to) {
    const diff = (to.getFullYear() - from.getFullYear()) * 12 + (to.getMonth() - from.getMonth());
    return Math.max(0, diff);
}
function fmtMonthDay(d) { return `${d.getMonth()+1}ì›” ${d.getDate()}ì¼`; }
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 6); }
function escHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// â”€â”€ íƒ­ ì „í™˜ â”€â”€
function switchApp(name, btn) {
    document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.main-tab').forEach(el => el.classList.remove('active'));
    document.getElementById('app-' + name).classList.add('active');
    btn.classList.add('active');
}
window.switchApp = switchApp;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ê¸ˆì£¼ ì•± (jk) â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const JK_DOC_REF = doc(db, 'challenge', 'main');
let D_jk = { records: [] };

function getCurrentStreak(records) {
    const sorted = [...records].sort((a, b) => b.date.localeCompare(a.date));
    let streak = 0;
    for (const r of sorted) {
        if (r.sober === 'O') streak++;
        else break;
    }
    return streak;
}

async function jk_load() {
    try {
        const snap = await getDoc(JK_DOC_REF);
        if (snap.exists()) D_jk = { records: [], ...snap.data() };
    } catch (e) {
        console.error('ê¸ˆì£¼ ë¡œë“œ ì‹¤íŒ¨:', e);
    }
    jk_renderTable();
}

function jk_save() {
    setDoc(JK_DOC_REF, D_jk).catch(err => console.error('ê¸ˆì£¼ ì €ì¥ ì‹¤íŒ¨:', err));
}

function jk_updateSoberCounter() {
    const streak = getCurrentStreak(D_jk.records);
    const countElem = document.getElementById('day-count');
    const textElem  = document.getElementById('streak-text');
    countElem.innerText = streak;
    if (streak === 0) {
        countElem.style.color = '#dc2626';
        textElem.innerText = 'ì¼ì°¨ - ë‹¤ì‹œ ì‹œì‘í•´ë´ìš”!';
    } else {
        countElem.style.color = '#0284c7';
        textElem.innerText = 'ì¼ì°¨ ê¸ˆì£¼ ì¤‘';
    }
    jk_renderMilestones(streak);
}

function jk_renderMilestones(streak) {
    const el = document.getElementById('jk-milestones');
    if (!el) return;

    // í˜„ì¬ ì—°ì† ìŠ¤íŠ¸ë¦­ì˜ ì‹œì‘ì¼ ê³„ì‚°
    const sorted = [...D_jk.records].sort((a, b) => b.date.localeCompare(a.date));
    let startDate = null;
    if (streak > 0) {
        // ê°€ì¥ ì˜¤ë˜ëœ ì—°ì† O ê¸°ë¡ ì°¾ê¸°
        let count = 0;
        for (const r of sorted) {
            if (r.sober === 'O') count++;
            else break;
        }
        // countë²ˆì§¸ ê¸°ë¡ì˜ ë‚ ì§œê°€ ì—°ì† ì‹œì‘ì¼
        const startRecord = sorted[count - 1];
        startDate = startRecord ? new Date(startRecord.date) : null;
    }

    const MILESTONES = [
        { day: 30,  icon: 'ğŸŒ±', label: '30ì¼' },
        { day: 50,  icon: 'â­', label: '50ì¼' },
        { day: 100, icon: 'ğŸ†', label: '100ì¼' },
    ];

    const today = new Date(); today.setHours(0,0,0,0);

    el.innerHTML = MILESTONES.map(m => {
        const isDone = streak >= m.day;

        let dateStr = '-';
        let ddayHtml = '';

        if (startDate) {
            // ëª©í‘œ ë‹¬ì„±ì¼ = ì‹œì‘ì¼ + (m.day - 1)ì¼
            const targetDate = new Date(startDate);
            targetDate.setDate(targetDate.getDate() + m.day - 1);
            const yyyy = targetDate.getFullYear();
            const mm   = String(targetDate.getMonth() + 1).padStart(2, '0');
            const dd   = String(targetDate.getDate()).padStart(2, '0');
            dateStr = `${yyyy}.${mm}.${dd}`;

            if (isDone) {
                ddayHtml = `<div class="mc-dday done">ë‹¬ì„± ì™„ë£Œ ğŸ‰</div>`;
            } else {
                const daysLeft = Math.ceil((targetDate - today) / 86400000);
                if (daysLeft <= 7) {
                    ddayHtml = `<div class="mc-dday soon">D-${daysLeft} ğŸ”¥</div>`;
                } else {
                    ddayHtml = `<div class="mc-dday future">D-${daysLeft}</div>`;
                }
            }
        } else {
            dateStr = 'ê¸°ë¡ ì—†ìŒ';
        }

        return `<div class="milestone-chip${isDone ? ' done' : ''}">
            <div class="mc-icon">${m.icon}</div>
            <div>
                <div class="mc-label">${m.label} ë‹¬ì„± ì˜ˆì •</div>
                <div class="mc-date">${dateStr}</div>
                ${ddayHtml}
            </div>
        </div>`;
    }).join('');
}

function jk_renderTable() {
    const tbody = document.getElementById('data-list');
    tbody.innerHTML = '';
    const sorted = [...D_jk.records].sort((a, b) => b.date.localeCompare(a.date));
    sorted.forEach(r => {
        const reasonHtml = r.reason ? `<span class="reason-label">ì‚¬ìœ : ${escHtml(r.reason)}</span>` : '';
        const safeDate     = escHtml(r.date);
        const safeSober    = escHtml(r.sober);
        const safeExercise = escHtml(r.exercise);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight:600;color:#4b5563;">${safeDate}</td>
            <td><span class="${r.sober === 'O' ? 'status-o' : 'status-x'}">${safeSober}</span>${reasonHtml}</td>
            <td class="${r.exercise === 'O' ? 'status-o' : 'status-x'}">${safeExercise}</td>
            <td>${escHtml(r.screen)}</td>
            <td style="text-align:left;font-size:0.9rem;">${escHtml(r.ai)}</td>
            <td>
                <button class="btn-edit" onclick="jk_editItem('${safeDate}')">ìˆ˜ì •</button>
                <button class="btn-del"  onclick="jk_deleteRecord('${safeDate}')">ì‚­ì œ</button>
            </td>`;
        tbody.appendChild(tr);
    });
    jk_updateSoberCounter();
}

function jk_toggleReason() {
    const isX = document.getElementById('sober').value === 'X';
    document.getElementById('reason-container').style.display = isX ? 'block' : 'none';
    if (!isX) document.getElementById('reason').value = '';
}

function jk_resetInputs() {
    document.getElementById('sober').value    = 'O';
    document.getElementById('exercise').value = 'O';
    document.getElementById('screen').value   = '';
    document.getElementById('ai').value       = '';
    document.getElementById('reason').value   = '';
    jk_toggleReason();
    const btn = document.getElementById('save-btn');
    btn.innerText = 'ê¸°ë¡í•˜ê¸°';
    btn.classList.remove('edit-mode');
}

function jk_addRecord() {
    const date     = document.getElementById('targetDate').value;
    const sober    = document.getElementById('sober').value;
    const exercise = document.getElementById('exercise').value;
    const screen   = document.getElementById('screen').value;
    const ai       = document.getElementById('ai').value;
    const reason   = sober === 'O' ? '' : document.getElementById('reason').value;
    if (!date) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

    const idx = D_jk.records.findIndex(r => r.date === date);
    const newRecord = { date, sober, exercise, screen, ai, reason };
    if (idx >= 0) {
        D_jk.records[idx] = newRecord;
    } else {
        D_jk.records.push(newRecord);
    }
    jk_save();

    document.getElementById('save-btn').innerText = 'ê¸°ë¡í•˜ê¸°';
    document.getElementById('save-btn').classList.remove('edit-mode');
    document.getElementById('screen').value = '';
    document.getElementById('ai').value     = '';
    document.getElementById('reason').value = '';
    jk_toggleReason();
    jk_renderTable();
}

function jk_editItem(date) {
    const r = D_jk.records.find(r => r.date === date);
    if (!r) return;
    document.getElementById('targetDate').value  = r.date;
    document.getElementById('sober').value       = r.sober;
    document.getElementById('exercise').value    = r.exercise;
    document.getElementById('screen').value      = r.screen  || '';
    document.getElementById('ai').value          = r.ai      || '';
    document.getElementById('reason').value      = r.sober === 'X' ? (r.reason || '') : '';
    document.getElementById('reason-container').style.display = r.sober === 'X' ? 'block' : 'none';
    const btn = document.getElementById('save-btn');
    btn.innerText = 'ìˆ˜ì • ì™„ë£Œ';
    btn.classList.add('edit-mode');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function jk_deleteRecord(date) {
    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        D_jk.records = D_jk.records.filter(r => r.date !== date);
        jk_save();
        jk_renderTable();
    }
}

window.jk_toggleReason = jk_toggleReason;
window.jk_resetInputs  = jk_resetInputs;
window.jk_addRecord    = jk_addRecord;
window.jk_editItem     = jk_editItem;
window.jk_deleteRecord = jk_deleteRecord;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ê°€ê³„ë¶€ ì•± (gk) â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GK_DOC_REF = doc(db, 'budget', 'main');
let _editingIncomeId = null;
let _editingFixedId  = null;
let _editingSubId    = null;
let _editingLoanId   = null;
const CATEGORY_ICONS = {
    streaming: 'ğŸ“º', music: 'ğŸµ', software: 'ğŸ’»', game: 'ğŸ®',
    cloud: 'â˜ï¸', food: 'ğŸ”', shopping: 'ğŸ›’', fitness: 'ğŸ‹ï¸',
    education: 'ğŸ“š', etc: 'ğŸŒ'
};
const DEFAULT = {
    goal: 5000000, targetDate: '2026-04-14', currentBalance: 0,
    balanceDate: todayStr(),
    emergencyFund: 1000000,
    incomeEvents: [],    // [{id, name, amount, date}]
    fixedExpenses: [],   // [{id, name, amount, date}]
    spendingLog: [],
    interestLog: [],     // ë ˆê±°ì‹œ (ë¯¸ì‚¬ìš©)
    subscriptions: [],   // [{id, name, category, cycle, amount, billingDay, billingDate, active}]
    loans: [],           // [{id, name, remainingBalance, interestRate, monthlyPayment, paymentDay, memo}]
    loanPayments: [],    // [{id, loanId, loanName, date, principal, interest, memo}]
    overdraftReminderMonth: ''  // 'YYYY-MM' - ë§ˆì§€ë§‰ìœ¼ë¡œ ì•Œë¦¼ í™•ì¸í•œ ì›”
};
let D = { ...DEFAULT };

async function loadFromFirestore() {
    try {
        const snap = await getDoc(GK_DOC_REF);
        if (snap.exists()) D = { ...DEFAULT, ...snap.data() };
    } catch(e) { console.error('ë¡œë“œ ì‹¤íŒ¨:', e); }
}
function save() {
    setDoc(GK_DOC_REF, D).catch(err => console.error('ì €ì¥ ì‹¤íŒ¨:', err));
}

function calcDashboard() {
    const today = new Date(); today.setHours(0,0,0,0);
    const target = new Date(D.targetDate); target.setHours(23,59,59,999);
    const remainDays = Math.max(1, Math.ceil((target - today) / 86400000));

    const balanceDateObj = new Date(D.balanceDate || '2000-01-01'); balanceDateObj.setHours(0,0,0,0);

    // í™•ì¸ëœ ìˆ˜ì…/ê³ ì •ë¹„ (balanceDate ì´í›„, actualAmount ìš°ì„  ì‚¬ìš©)
    const confirmedIncome = (D.incomeEvents || [])
        .filter(x => x.confirmed && new Date(x.date) >= balanceDateObj)
        .reduce((s,x) => s + (x.actualAmount != null ? x.actualAmount : x.amount), 0);
    const confirmedFixed = (D.fixedExpenses || [])
        .filter(x => x.confirmed && new Date(x.date) >= balanceDateObj)
        .reduce((s,x) => s + (x.actualAmount != null ? x.actualAmount : x.amount), 0);

    const loggedSpent = D.spendingLog.filter(x => new Date(x.date) >= balanceDateObj).reduce((s,x) => s+x.amount, 0);
    const currentBalance = D.currentBalance + confirmedIncome - confirmedFixed - loggedSpent;

    // ëª©í‘œì¼ ì „ê¹Œì§€ ë¯¸ì™„ë£Œ ì˜ˆì • ìˆ˜ì…/ê³ ì •ë¹„ í•©ì‚°
    const futureIncome = (D.incomeEvents || [])
        .filter(x => !x.confirmed && new Date(x.date) > today && new Date(x.date) <= target)
        .reduce((s,x) => s + x.amount, 0);
    const futureFixed = (D.fixedExpenses || [])
        .filter(x => !x.confirmed && new Date(x.date) > today && new Date(x.date) <= target)
        .reduce((s,x) => s + x.amount, 0);

    // ëª©í‘œì¼ ì „ê¹Œì§€ í™œì„± êµ¬ë…ë£Œ í•©ì‚°
    const futureSubscriptions = (D.subscriptions || [])
        .filter(s => s.active)
        .reduce((sum, sub) => {
            if (sub.cycle === 'monthly' && sub.billingDay) {
                let d = new Date(today.getFullYear(), today.getMonth(), sub.billingDay);
                if (d <= today) d = new Date(today.getFullYear(), today.getMonth() + 1, sub.billingDay);
                let count = 0;
                while (d <= target) { count++; d = new Date(d.getFullYear(), d.getMonth() + 1, sub.billingDay); }
                return sum + sub.amount * count;
            } else if (sub.cycle === 'yearly' && sub.billingDate) {
                const ref = new Date(sub.billingDate);
                let d = new Date(today.getFullYear(), ref.getMonth(), ref.getDate());
                if (d <= today) d = new Date(today.getFullYear() + 1, ref.getMonth(), ref.getDate());
                return sum + (d <= target ? sub.amount : 0);
            }
            return sum;
        }, 0);

    const totalAvailable = currentBalance + futureIncome - futureFixed - futureSubscriptions - D.goal - (D.emergencyFund || 0);
    const dailyMax = totalAvailable / remainDays;
    const todayKey = fmtDate(today);
    const todaySpent = D.spendingLog.filter(x => x.date === todayKey).reduce((s,x) => s+x.amount, 0);
    const todayRemain = dailyMax - todaySpent;
    const totalSpent = loggedSpent;
    const pct = Math.min(100, Math.max(0, (currentBalance / D.goal) * 100));

    // ì•ìœ¼ë¡œ 7ì¼ ë‚´ ë¯¸ì™„ë£Œ ì˜ˆì • ê±°ë˜ (ìˆ˜ì… + ê³ ì •ë¹„)
    const next7 = new Date(today); next7.setDate(next7.getDate() + 7);
    const upcomingIncome = (D.incomeEvents || [])
        .filter(x => !x.confirmed && new Date(x.date) >= today && new Date(x.date) <= next7)
        .map(x => ({ name: x.name, amount: x.amount, date: new Date(x.date), type: 'income' }));
    const upcomingFixed = (D.fixedExpenses || [])
        .filter(x => !x.confirmed && new Date(x.date) >= today && new Date(x.date) <= next7)
        .map(x => ({ name: x.name, amount: x.amount, date: new Date(x.date), type: 'expense' }));
    const upcomingLoans = (D.loans || [])
        .map(loan => {
            if (!loan.paymentDay) return null;
            let d = new Date(today.getFullYear(), today.getMonth(), loan.paymentDay);
            if (d < today) d = new Date(today.getFullYear(), today.getMonth() + 1, loan.paymentDay);
            if (d > next7) return null;
            const schedule = calcRepaymentSchedule(loan);
            const payment = (schedule && schedule.length > 0) ? schedule[0].payment : (loan.monthlyPayment || 0);
            if (!payment) return null;
            return { name: `${loan.name} ë‚©ë¶€`, amount: payment, date: d, type: 'expense' };
        })
        .filter(Boolean);
    const upcomingSubscriptions = (D.subscriptions || [])
        .filter(s => s.active)
        .map(sub => {
            let d;
            if (sub.cycle === 'monthly' && sub.billingDay) {
                d = new Date(today.getFullYear(), today.getMonth(), sub.billingDay);
                if (d < today) d = new Date(today.getFullYear(), today.getMonth() + 1, sub.billingDay);
            } else if (sub.cycle === 'yearly' && sub.billingDate) {
                const ref = new Date(sub.billingDate);
                d = new Date(today.getFullYear(), ref.getMonth(), ref.getDate());
                if (d < today) d = new Date(today.getFullYear() + 1, ref.getMonth(), ref.getDate());
            }
            if (d && d >= today && d <= next7) return { name: `${sub.name} êµ¬ë…ë£Œ`, amount: sub.amount, date: d, type: 'expense' };
            return null;
        })
        .filter(Boolean);
    const upcomingItems = [...upcomingIncome, ...upcomingFixed, ...upcomingLoans, ...upcomingSubscriptions].sort((a,b) => a.date - b.date);

    return { remainDays, currentBalance, dailyMax, todaySpent, todayRemain, totalSpent, pct, upcomingItems };
}

function updateDashboard() {
    const c = calcDashboard();
    document.getElementById('dash-title').textContent = `ğŸ¯ ${fmtMonthDay(new Date(D.targetDate))} ê¹Œì§€ ${fmtMoney(D.goal)} ëª¨ìœ¼ê¸°`;
    document.getElementById('dash-dday').textContent  = `D-${c.remainDays}`;
    document.getElementById('dash-pct').textContent   = `${Math.round(c.pct)}%`;
    document.getElementById('dash-balance').textContent     = fmtMoney(c.currentBalance);
    document.getElementById('dash-month-spent').textContent = fmtMoney(c.totalSpent);
    const remainEl = document.getElementById('dash-today-remain');
    if (c.todayRemain < 0) {
        remainEl.textContent = `- ${fmtMoney(Math.abs(c.todayRemain))}`;
        remainEl.className = 'daily-budget-amount over';
        document.getElementById('alert-over').style.display = 'block';
    } else {
        remainEl.textContent = fmtMoney(c.todayRemain);
        remainEl.className = 'daily-budget-amount';
        document.getElementById('alert-over').style.display = 'none';
    }
    document.getElementById('dash-today-sub').textContent  = `ì¼ ê¸°ì¤€ ${fmtMoney(c.dailyMax)} Â· ì˜¤ëŠ˜ ì§€ì¶œ ${fmtMoney(c.todaySpent)}`;
    document.getElementById('dash-saved-label').textContent = `í˜„ì¬ ${fmtMoney(c.currentBalance)}`;
    document.getElementById('dash-goal-label').textContent  = `ëª©í‘œ ${fmtMoney(D.goal)}`;
    document.getElementById('dash-progress').style.width    = `${c.pct}%`;
    const noticeEl = document.getElementById('notice-upcoming');
    if (c.upcomingItems.length > 0) {
        noticeEl.style.display = 'block';
        document.getElementById('notice-list').innerHTML = c.upcomingItems.map(it => {
            const sign  = it.type === 'income' ? '+' : 'âˆ’';
            const color = it.type === 'income' ? '#276749' : '#c53030';
            const tag   = it.type === 'income' ? 'ìˆ˜ì…' : 'ì§€ì¶œ';
            return `<div class="notice-row"><span>${escHtml(it.name)} <span style="opacity:0.75;font-size:0.72rem">(${it.date.getMonth()+1}/${it.date.getDate()} ${tag})</span></span><span style="color:${color};font-weight:700;">${sign}${fmtMoney(it.amount)}</span></div>`;
        }).join('');
    } else { noticeEl.style.display = 'none'; }

    // ì˜ˆì •ì¼ ê²½ê³¼ ë¯¸í™•ì¸ í•­ëª© ê²½ê³ 
    const todayDateStr = fmtDate(new Date());
    const overdueCount = [
        ...(D.incomeEvents || []).filter(x => !x.confirmed && x.date < todayDateStr),
        ...(D.fixedExpenses || []).filter(x => !x.confirmed && x.date < todayDateStr)
    ].length;
    const pendingEl = document.getElementById('alert-pending');
    if (overdueCount > 0) {
        document.getElementById('alert-pending-count').textContent = overdueCount;
        pendingEl.style.display = 'block';
    } else {
        pendingEl.style.display = 'none';
    }

    // ë§ˆì´ë„ˆìŠ¤ í†µì¥ ì›”ë§ ì—…ë°ì´íŠ¸ ì•Œë¦¼
    const hasOverdraft = (D.loans || []).some(l => l.repaymentType === 'overdraft');
    const reminderEl = document.getElementById('alert-overdraft-reminder');
    if (hasOverdraft) {
        const now = new Date();
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        const isNearMonthEnd = now.getDate() >= lastDayOfMonth - 2;  // ë§ì¼ 3ì¼ ì „ë¶€í„°
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const alreadyDismissed = (D.overdraftReminderMonth || '') === currentMonth;
        reminderEl.style.display = (isNearMonthEnd && !alreadyDismissed) ? 'flex' : 'none';
    } else {
        reminderEl.style.display = 'none';
    }
}

function renderLog() {
    const el = document.getElementById('log-list');
    const sorted = [...D.spendingLog].sort((a,b) => b.date.localeCompare(a.date) || b.id.localeCompare(a.id));
    if (sorted.length === 0) { el.innerHTML = '<div class="empty">ì•„ì§ ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
    const groups = {};
    sorted.forEach(item => { if (!groups[item.date]) groups[item.date] = []; groups[item.date].push(item); });
    let html = '';
    Object.entries(groups).forEach(([date, items]) => {
        const dayTotal = items.reduce((s,x) => s+x.amount, 0);
        html += `<div style="font-size:0.8rem;font-weight:700;color:#718096;padding:8px 0 4px;border-top:1px solid #f0f4f8;margin-top:4px;">${fmtMonthDay(new Date(date))} <span style="font-weight:400;color:#a0aec0;">í•©ê³„ ${fmtMoney(dayTotal)}</span></div>`;
        items.forEach(item => {
            html += `<div class="list-item"><div class="info"><div class="name">${escHtml(item.desc)}</div></div><div class="right"><span class="amount">âˆ’${fmtMoney(item.amount)}</span><button class="btn-sm" onclick="deleteSpending('${item.id}')">ì‚­ì œ</button></div></div>`;
        });
    });
    el.innerHTML = html;
}

function renderIncome() {
    const el = document.getElementById('income-list');
    const totalWrap = document.getElementById('income-total-wrap');
    const events = D.incomeEvents || [];
    if (events.length === 0) { el.innerHTML = '<div class="empty">ë“±ë¡ëœ ì˜ˆì • ìˆ˜ì…ì´ ì—†ìŠµë‹ˆë‹¤</div>'; totalWrap.style.display = 'none'; return; }
    const sorted = [...events].sort((a,b) => a.date.localeCompare(b.date));
    const total  = sorted.reduce((s,x) => s+x.amount, 0);
    el.innerHTML = sorted.map(ie => {
        if (ie.confirmed) {
            const actual = ie.actualAmount != null ? ie.actualAmount : ie.amount;
            const diff = actual - ie.amount;
            const diffHtml = diff !== 0
                ? `<span style="color:${diff > 0 ? '#276749' : '#c53030'};font-size:0.77rem;"> (${diff > 0 ? '+' : 'âˆ’'}${fmtMoney(Math.abs(diff))})</span>`
                : '';
            return `<div class="list-item" style="opacity:0.8"><div class="info"><div class="name">âœ… ${escHtml(ie.name)}</div><div class="sub">${escHtml(ie.date)} Â· ì˜ˆì • ${fmtMoney(ie.amount)} â†’ ì‹¤ì œ ${fmtMoney(actual)}${diffHtml}</div></div><div class="right"><button class="btn-sm-unconfirm" onclick="unconfirmIncome('${ie.id}')">í™•ì¸ì·¨ì†Œ</button><button class="btn-sm" onclick="deleteIncome('${ie.id}')">ì‚­ì œ</button></div></div>`;
        } else {
            return `<div class="list-item"><div class="info"><div class="name">${escHtml(ie.name)}</div><div class="sub">${escHtml(ie.date)}</div></div><div class="right"><span class="amount" style="color:#276749;">+${fmtMoney(ie.amount)}</span><button class="btn-sm-confirm" onclick="confirmIncome('${ie.id}')">ìˆ˜ì…í™•ì¸</button><button class="btn-sm-edit" onclick="editIncome('${ie.id}')">ìˆ˜ì •</button><button class="btn-sm" onclick="deleteIncome('${ie.id}')">ì‚­ì œ</button></div></div>`;
        }
    }).join('');
    document.getElementById('income-total-amount').textContent = `+${fmtMoney(total)}`;
    totalWrap.style.display = 'block';
}

function renderFixed() {
    const el = document.getElementById('fixed-list');
    const totalWrap = document.getElementById('fixed-total-wrap');
    if (D.fixedExpenses.length === 0) { el.innerHTML = '<div class="empty">ë“±ë¡ëœ ê³ ì •ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</div>'; totalWrap.style.display = 'none'; return; }
    const sorted = [...D.fixedExpenses].sort((a,b) => a.date.localeCompare(b.date));
    const total  = sorted.reduce((s,x) => s+x.amount, 0);
    el.innerHTML = sorted.map(fe => {
        if (fe.confirmed) {
            const actual = fe.actualAmount != null ? fe.actualAmount : fe.amount;
            const saved = fe.amount - actual; // ì–‘ìˆ˜ = ì ˆì•½, ìŒìˆ˜ = ì´ˆê³¼
            const diffHtml = saved !== 0
                ? `<span style="color:${saved > 0 ? '#276749' : '#c53030'};font-size:0.77rem;"> (${saved > 0 ? 'ì ˆì•½ ' : 'ì´ˆê³¼ '}${fmtMoney(Math.abs(saved))})</span>`
                : '';
            return `<div class="list-item" style="opacity:0.8"><div class="info"><div class="name">âœ… ${escHtml(fe.name)}</div><div class="sub">${escHtml(fe.date)} Â· ì˜ˆì • ${fmtMoney(fe.amount)} â†’ ì‹¤ì œ ${fmtMoney(actual)}${diffHtml}</div></div><div class="right"><button class="btn-sm-unconfirm" onclick="unconfirmFixed('${fe.id}')">í™•ì¸ì·¨ì†Œ</button><button class="btn-sm" onclick="deleteFixed('${fe.id}')">ì‚­ì œ</button></div></div>`;
        } else {
            return `<div class="list-item"><div class="info"><div class="name">${escHtml(fe.name)}</div><div class="sub">${escHtml(fe.date)}</div></div><div class="right"><span class="amount">âˆ’${fmtMoney(fe.amount)}</span><button class="btn-sm-confirm" onclick="confirmFixed('${fe.id}')">ì§€ì¶œì™„ë£Œ</button><button class="btn-sm-edit" onclick="editFixed('${fe.id}')">ìˆ˜ì •</button><button class="btn-sm" onclick="deleteFixed('${fe.id}')">ì‚­ì œ</button></div></div>`;
        }
    }).join('');
    document.getElementById('fixed-total-amount').textContent = `âˆ’${fmtMoney(total)}`;
    totalWrap.style.display = 'block';
}

function renderSettings() {
    document.getElementById('s-goal').value      = D.goal;
    document.getElementById('s-target').value    = D.targetDate;
    document.getElementById('s-balance').value   = D.currentBalance;
    document.getElementById('s-emergency').value = D.emergencyFund ?? 1000000;
}

function showTab(name) {
    ['log','income','fixed','subscription','loan','settings'].forEach(t => {
        document.getElementById(`tab-${t}`).style.display = t === name ? 'block' : 'none';
    });
    document.querySelectorAll('#app-gk .gk-tab').forEach((el, i) => {
        el.classList.toggle('active', ['log','income','fixed','subscription','loan','settings'][i] === name);
    });
    if (name === 'settings') renderSettings();
    if (name === 'subscription') renderSubscriptions();
    if (name === 'loan') renderLoans();
}

function addSpending() {
    const date   = document.getElementById('log-date').value;
    const amount = parseInt(document.getElementById('log-amount').value);
    const desc   = document.getElementById('log-desc').value.trim();
    if (!date || !desc || !amount || amount <= 0) { alert('ë‚ ì§œ, ë‚´ìš©, ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    D.spendingLog.push({ id: uid(), date, desc, amount });
    save();
    document.getElementById('log-amount').value = '';
    document.getElementById('log-desc').value   = '';
    renderLog(); updateDashboard();
}
function deleteSpending(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    D.spendingLog = D.spendingLog.filter(x => x.id !== id);
    save(); renderLog(); updateDashboard();
}
function editIncome(id) {
    const item = (D.incomeEvents || []).find(x => x.id === id);
    if (!item) return;
    _editingIncomeId = id;
    document.getElementById('income-name').value   = item.name;
    document.getElementById('income-amount').value = item.amount;
    document.getElementById('income-date').value   = item.date;
    const btn = document.getElementById('income-submit-btn');
    btn.textContent = 'âœï¸ ìˆ˜ì • ì™„ë£Œ';
    btn.style.background = '#f6ad55';
    document.getElementById('tab-income').scrollIntoView({ behavior: 'smooth' });
}
function addIncome() {
    const name   = document.getElementById('income-name').value.trim();
    const amount = parseInt(document.getElementById('income-amount').value);
    const date   = document.getElementById('income-date').value;
    if (!name || !amount || amount <= 0 || !date) { alert('í•­ëª©ëª…, ê¸ˆì•¡, ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (!D.incomeEvents) D.incomeEvents = [];
    if (_editingIncomeId) {
        const idx = D.incomeEvents.findIndex(x => x.id === _editingIncomeId);
        if (idx >= 0) D.incomeEvents[idx] = { id: _editingIncomeId, name, amount, date };
        _editingIncomeId = null;
        const btn = document.getElementById('income-submit-btn');
        btn.textContent = '+ ìˆ˜ì… ë“±ë¡';
        btn.style.background = '';
    } else {
        D.incomeEvents.push({ id: uid(), name, amount, date });
    }
    save();
    document.getElementById('income-name').value   = '';
    document.getElementById('income-amount').value = '';
    document.getElementById('income-date').value   = '';
    renderIncome(); updateDashboard();
}
function deleteIncome(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    D.incomeEvents = (D.incomeEvents || []).filter(x => x.id !== id);
    save(); renderIncome(); updateDashboard();
}
function editFixed(id) {
    const item = D.fixedExpenses.find(x => x.id === id);
    if (!item) return;
    _editingFixedId = id;
    document.getElementById('fixed-name').value   = item.name;
    document.getElementById('fixed-amount').value = item.amount;
    document.getElementById('fixed-date').value   = item.date;
    const btn = document.getElementById('fixed-submit-btn');
    btn.textContent = 'âœï¸ ìˆ˜ì • ì™„ë£Œ';
    btn.style.background = '#f6ad55';
    document.getElementById('fixed-submit-btn').scrollIntoView({ behavior: 'smooth' });
}
function addFixed() {
    const name   = document.getElementById('fixed-name').value.trim();
    const amount = parseInt(document.getElementById('fixed-amount').value);
    const date   = document.getElementById('fixed-date').value;
    if (!name || !amount || amount <= 0 || !date) { alert('í•­ëª©ëª…, ê¸ˆì•¡, ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (_editingFixedId) {
        const idx = D.fixedExpenses.findIndex(x => x.id === _editingFixedId);
        if (idx >= 0) D.fixedExpenses[idx] = { id: _editingFixedId, name, amount, date };
        _editingFixedId = null;
        const btn = document.getElementById('fixed-submit-btn');
        btn.textContent = '+ ê³ ì •ë¹„ ë“±ë¡';
        btn.style.background = '';
    } else {
        D.fixedExpenses.push({ id: uid(), name, amount, date });
    }
    save();
    document.getElementById('fixed-name').value   = '';
    document.getElementById('fixed-amount').value = '';
    document.getElementById('fixed-date').value   = '';
    renderFixed(); updateDashboard();
}
function deleteFixed(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    D.fixedExpenses = D.fixedExpenses.filter(x => x.id !== id);
    save(); renderFixed(); updateDashboard();
}

function confirmIncome(id) {
    const item = (D.incomeEvents || []).find(x => x.id === id);
    if (!item) return;
    const input = prompt(`ì‹¤ì œ ìˆ˜ì… ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆì •: ${item.amount.toLocaleString()}ì›)`, item.amount);
    if (input === null) return;
    const actual = parseInt(String(input).replace(/,/g, ''));
    if (isNaN(actual) || actual < 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    item.confirmed = true;
    item.actualAmount = actual;
    save(); renderIncome(); updateDashboard();
}
function unconfirmIncome(id) {
    const item = (D.incomeEvents || []).find(x => x.id === id);
    if (!item) return;
    item.confirmed = false;
    item.actualAmount = null;
    save(); renderIncome(); updateDashboard();
}
function confirmFixed(id) {
    const item = D.fixedExpenses.find(x => x.id === id);
    if (!item) return;
    const input = prompt(`ì‹¤ì œ ì§€ì¶œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆì •: ${item.amount.toLocaleString()}ì›)`, item.amount);
    if (input === null) return;
    const actual = parseInt(String(input).replace(/,/g, ''));
    if (isNaN(actual) || actual < 0) { alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    item.confirmed = true;
    item.actualAmount = actual;
    save(); renderFixed(); updateDashboard();
}
function unconfirmFixed(id) {
    const item = D.fixedExpenses.find(x => x.id === id);
    if (!item) return;
    item.confirmed = false;
    item.actualAmount = null;
    save(); renderFixed(); updateDashboard();
}
function dismissOverdraftReminder() {
    const now = new Date();
    D.overdraftReminderMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    save();
    document.getElementById('alert-overdraft-reminder').style.display = 'none';
}

function saveSettings() {
    const goal          = parseInt(document.getElementById('s-goal').value);
    const targetDate    = document.getElementById('s-target').value;
    const balance       = parseInt(document.getElementById('s-balance').value) || 0;
    const emergencyFund = parseInt(document.getElementById('s-emergency').value) || 0;
    if (!goal || goal <= 0 || !targetDate) { alert('ëª©í‘œ ê¸ˆì•¡ê³¼ ëª©í‘œ ë‚ ì§œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    if (balance !== D.currentBalance) D.balanceDate = todayStr();
    D.goal = goal; D.targetDate = targetDate; D.currentBalance = balance; D.emergencyFund = emergencyFund;
    save(); updateDashboard(); alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// â”€â”€ ëŒ€ì¶œ ê´€ë¦¬ â”€â”€

function loanRepayTypeChange() {
    const type = document.getElementById('loan-repay-type').value;
    const isOD = type === 'overdraft';
    document.getElementById('loan-grace-group').style.display    = isOD ? 'none' : '';
    document.getElementById('loan-end-group').style.display      = isOD ? 'none' : '';
    document.getElementById('loan-overdraft-group').style.display = isOD ? '' : 'none';
    document.getElementById('loan-balance-label').textContent    = isOD ? 'í˜„ì¬ ë§ˆì´ë„ˆìŠ¤ ì”ì•¡ (ì›)' : 'ëŒ€ì¶œ ì›ê¸ˆ / ì”ì—¬ê¸ˆ (ì›)';
    autoCalcLoanPayment();
}
function syncOverdraftPayday() {
    document.getElementById('loan-payday').value = document.getElementById('loan-payday-od').value;
}

function autoCalcLoanPayment() {
    const type         = document.getElementById('loan-repay-type').value;
    const balance      = parseInt(document.getElementById('loan-balance').value)  || 0;
    const rate         = parseFloat(document.getElementById('loan-rate').value)   || 0;
    const graceDateVal = document.getElementById('loan-grace-date').value;
    const endDateVal   = document.getElementById('loan-end-date').value;
    const preview      = document.getElementById('loan-calc-preview');
    const body         = document.getElementById('loan-preview-body');

    // ë§ˆì´ë„ˆìŠ¤ í†µì¥: ë‚ ì§œ ë¶ˆí•„ìš”, ì”ì•¡+ê¸ˆë¦¬ë§Œ ìˆìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸°
    if (type === 'overdraft') {
        if (!balance || !rate) { preview.style.display = 'none'; return; }
        const r = rate / 100 / 12;
        const monthlyInt = Math.round(balance * r);
        document.getElementById('loan-monthly').value = monthlyInt;
        body.innerHTML = `
            <div class="loan-preview-row">
                <span class="loan-preview-label">ì›” ì´ì ë‚©ë¶€ì•¡ (í˜„ ì”ì•¡ ê¸°ì¤€)</span>
                <span class="loan-preview-val red">${fmtMoney(monthlyInt)}</span>
            </div>
            <div class="loan-preview-row">
                <span class="loan-preview-label">ì—°ê°„ ì´ì í•©ê³„ (ì”ì•¡ ë¶ˆë³€ ì‹œ)</span>
                <span class="loan-preview-val red">${fmtMoney(monthlyInt * 12)}</span>
            </div>`;
        preview.style.display = 'block';
        return;
    }

    if (!balance || !rate || !endDateVal || !type) { preview.style.display = 'none'; return; }

    const today     = new Date(); today.setHours(0,0,0,0);
    const graceDate = graceDateVal ? new Date(graceDateVal) : null;
    const endDate   = new Date(endDateVal);
    const grace     = graceDate ? monthDiff(today, graceDate) : 0;
    const refDate   = (graceDate && grace > 0) ? graceDate : today;
    const months    = monthDiff(refDate, endDate);

    if (months <= 0) { preview.style.display = 'none'; return; }

    const r = rate / 100 / 12;
    const graceInterest = Math.round(balance * r);
    let rows = '';
    let repMonthly = 0;

    if (grace > 0) {
        rows += `<div class="loan-preview-row">
            <span class="loan-preview-label">ê±°ì¹˜ê¸°í•œ ì›” ë‚©ë¶€ì•¡ (ì´ìë§Œ, ${grace}ê°œì›”)</span>
            <span class="loan-preview-val red">${fmtMoney(graceInterest)}</span>
        </div>`;
    }

    if (type === 'annuity') {
        repMonthly = r === 0
            ? Math.round(balance / months)
            : Math.round(balance * (r * Math.pow(1+r, months)) / (Math.pow(1+r, months) - 1));
        const firstInt  = Math.round(balance * r);
        const firstPrin = repMonthly - firstInt;
        const totalInt  = repMonthly * months - balance + (grace > 0 ? graceInterest * grace : 0);
        rows += `<div class="loan-preview-row">
            <span class="loan-preview-label">ëŒ€ì¶œê¸°í•œ ì›” ë‚©ë¶€ì•¡ (ê³ ì •, ${months}ê°œì›”)</span>
            <span class="loan-preview-val">${fmtMoney(repMonthly)}</span>
        </div>
        <div class="loan-preview-row">
            <span class="loan-preview-label">â”” ì²« ë‹¬ ì›ê¸ˆ / ì´ì</span>
            <span class="loan-preview-sub">${fmtMoney(firstPrin)} / <span style="color:#e53e3e">${fmtMoney(firstInt)}</span></span>
        </div>
        <div class="loan-preview-row">
            <span class="loan-preview-label">ì´ ë‚©ë¶€ ì´ì í•©ê³„</span>
            <span class="loan-preview-val red">${fmtMoney(Math.max(0, totalInt))}</span>
        </div>`;
    } else if (type === 'principal_equal') {
        const prin1     = Math.round(balance / months);
        const int1      = Math.round(balance * r);
        const intLast   = Math.round(prin1 * r);
        repMonthly      = prin1 + int1;
        const totalInt  = Math.round(r * (balance * months - prin1 * months * (months - 1) / 2))
                          + (grace > 0 ? graceInterest * grace : 0);
        rows += `<div class="loan-preview-row">
            <span class="loan-preview-label">ëŒ€ì¶œê¸°í•œ ì²« ë‹¬ ë‚©ë¶€ì•¡</span>
            <span class="loan-preview-val">${fmtMoney(repMonthly)}</span>
        </div>
        <div class="loan-preview-row">
            <span class="loan-preview-label">â”” ë§¤ë‹¬ ì›ê¸ˆ / ì²« ë‹¬ ì´ì</span>
            <span class="loan-preview-sub">${fmtMoney(prin1)} / <span style="color:#e53e3e">${fmtMoney(int1)}</span></span>
        </div>
        <div class="loan-preview-row">
            <span class="loan-preview-label">ë§ˆì§€ë§‰ ë‹¬ ë‚©ë¶€ì•¡ (ì•½)</span>
            <span class="loan-preview-val">${fmtMoney(prin1 + intLast)}</span>
        </div>
        <div class="loan-preview-row">
            <span class="loan-preview-label">ì´ ë‚©ë¶€ ì´ì í•©ê³„</span>
            <span class="loan-preview-val red">${fmtMoney(Math.max(0, totalInt))}</span>
        </div>`;
    }

    document.getElementById('loan-monthly').value = repMonthly;
    body.innerHTML = rows;
    preview.style.display = 'block';
}

function calcRepaymentSchedule(loan) {
    if (!loan.repaymentType || loan.interestRate == null || !loan.remainingBalance) return null;

    const today = new Date(); today.setHours(0,0,0,0);
    const payDay = loan.paymentDay || 1;
    let payDate  = new Date(today.getFullYear(), today.getMonth(), payDay);
    if (payDate <= today) payDate = new Date(today.getFullYear(), today.getMonth() + 1, payDay);

    // ë§ˆì´ë„ˆìŠ¤ í†µì¥: í˜„ ì”ì•¡ ê¸°ì¤€ 12ê°œì›” ì´ìë§Œ ì˜ˆì¸¡
    if (loan.repaymentType === 'overdraft') {
        const r = loan.interestRate / 100 / 12;
        const interest = Math.round(loan.remainingBalance * r);
        return Array.from({ length: 12 }, (_, i) => {
            const d = new Date(payDate.getFullYear(), payDate.getMonth() + i, payDay);
            return {
                month: i + 1,
                date: `${d.getFullYear()}.${pad(d.getMonth() + 1)}`,
                principal: 0, interest,
                payment: interest,
                balance: loan.remainingBalance,
                isGrace: false, isOverdraft: true
            };
        });
    }

    // ë‚ ì§œ ê¸°ë°˜ìœ¼ë¡œ ë™ì  ê³„ì‚° (ì €ì¥ëœ ë‚ ì§œ ìš°ì„ )
    let grace, n;
    if (loan.loanEndDate) {
        const graceDate = loan.gracePeriodEndDate ? new Date(loan.gracePeriodEndDate) : null;
        const endDate   = new Date(loan.loanEndDate);
        grace           = graceDate ? monthDiff(today, graceDate) : 0;
        const refDate   = (graceDate && grace > 0) ? graceDate : today;
        n               = monthDiff(refDate, endDate);
    } else {
        grace = loan.gracePeriod || 0;
        n     = loan.remainingMonths;
    }
    if (!n) return null;

    const r     = loan.interestRate / 100 / 12;
    let balance = loan.remainingBalance;
    const schedule = [];

    // ê±°ì¹˜ê¸°í•œ: ì´ìë§Œ ë‚©ë¶€
    for (let i = 0; i < grace; i++) {
        const interest = Math.round(balance * r);
        schedule.push({
            month: i + 1,
            date: `${payDate.getFullYear()}.${pad(payDate.getMonth() + 1)}`,
            principal: 0, interest,
            payment: interest, balance,
            isGrace: true
        });
        payDate = new Date(payDate.getFullYear(), payDate.getMonth() + 1, payDay);
    }

    // ëŒ€ì¶œê¸°í•œ
    let fixedPayment = 0;
    if (loan.repaymentType === 'annuity') {
        fixedPayment = r === 0
            ? Math.round(balance / n)
            : Math.round(balance * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1));
    }

    for (let i = 0; i < n && balance > 0; i++) {
        const interest = Math.round(balance * r);
        let principal;
        if (loan.repaymentType === 'principal_equal') {
            const base = Math.round(loan.remainingBalance / n);
            principal  = (i === n - 1) ? balance : Math.min(base, balance);
        } else {
            principal = (i === n - 1) ? balance : Math.max(0, fixedPayment - interest);
        }
        balance = Math.max(0, balance - principal);
        schedule.push({
            month: grace + i + 1,
            date: `${payDate.getFullYear()}.${pad(payDate.getMonth() + 1)}`,
            principal, interest,
            payment: principal + interest, balance,
            isGrace: false
        });
        payDate = new Date(payDate.getFullYear(), payDate.getMonth() + 1, payDay);
    }
    return schedule;
}

function toggleLoanSchedule(id) {
    const wrap = document.getElementById(`schedule-wrap-${id}`);
    const btn  = document.getElementById(`schedule-btn-${id}`);
    if (!wrap) return;
    const open = wrap.classList.toggle('open');
    btn.textContent = open ? 'â–² ìƒí™˜ ì¼ì • ë‹«ê¸°' : 'â–¼ ìƒí™˜ ì¼ì • ë³´ê¸°';
}

function getLoanNextPayDate(loan) {
    if (!loan.paymentDay) return null;
    const today = new Date(); today.setHours(0,0,0,0);
    let d = new Date(today.getFullYear(), today.getMonth(), loan.paymentDay);
    if (d < today) d = new Date(today.getFullYear(), today.getMonth() + 1, loan.paymentDay);
    return d;
}

function renderLoans() {
    const loans = D.loans || [];
    const summaryCard = document.getElementById('loan-summary-card');
    const el = document.getElementById('loan-list');

    // ëŒ€ì¶œ ì—†ì„ ë•Œ
    if (loans.length === 0) {
        summaryCard.style.display = 'none';
        el.innerHTML = '<div class="empty">ë“±ë¡ëœ ëŒ€ì¶œì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    // ìš”ì•½
    const totalBalance  = loans.reduce((s, l) => s + (l.remainingBalance || 0), 0);
    const monthlySum    = loans.reduce((s, l) => s + (l.monthlyPayment  || 0), 0);
    summaryCard.style.display = 'block';
    document.getElementById('loan-total-balance').textContent = fmtMoney(totalBalance);
    document.getElementById('loan-monthly-sum').textContent   = fmtMoney(monthlySum);
    document.getElementById('loan-count').textContent         = `${loans.length}ê±´`;

    // ëŒ€ì¶œ ëª©ë¡
    const today = new Date(); today.setHours(0,0,0,0);
    el.innerHTML = loans.map(loan => {
        const nextDate = getLoanNextPayDate(loan);
        const daysLeft = nextDate ? Math.ceil((nextDate - today) / 86400000) : null;
        const isSoon   = daysLeft !== null && daysLeft <= 7;
        const nextStr  = nextDate ? `ë‹¤ìŒ ë‚©ë¶€ì¼: ${fmtDate(nextDate)}${isSoon ? ` (D-${daysLeft})` : ''}` : 'ë‚©ë¶€ì¼ ë¯¸ì„¤ì •';
        const nextClass = isSoon ? 'loan-next-pay' : 'loan-next-pay far';

        // ìƒí™˜ ë°©ì‹ ë±ƒì§€
        const repayLabel = loan.repaymentType === 'annuity'         ? 'ì›ë¦¬ê¸ˆê· ë“±'
                         : loan.repaymentType === 'principal_equal' ? 'ì›ê¸ˆê· ë“±'
                         : loan.repaymentType === 'overdraft'       ? 'ë§ˆì´ë„ˆìŠ¤í†µì¥'
                         : null;
        const isOverdraft = loan.repaymentType === 'overdraft';

        // ìƒí™˜ ì¼ì • ê³„ì‚°
        const schedule      = calcRepaymentSchedule(loan);
        const payoffEntry   = (!isOverdraft && schedule) ? schedule[schedule.length - 1] : null;
        const payoffStr     = payoffEntry ? payoffEntry.date.replace('.', 'ë…„ ') + 'ì›”' : null;

        const predHtml = schedule ? `
            <div class="loan-pred-box">
                ${schedule.slice(0, 3).map(m => {
                    const [y, mo] = m.date.split('.');
                    const dateLabel = `${y}ë…„ ${parseInt(mo)}ì›”${loan.paymentDay ? ' ' + loan.paymentDay + 'ì¼' : ''}`;
                    return `<div class="loan-pred-row">
                        <span class="loan-pred-label">${dateLabel}${m.isGrace ? ' <span style="font-size:0.65rem;background:#fef3c7;color:#92400e;padding:1px 4px;border-radius:3px;margin-left:3px;">ê±°ì¹˜</span>' : ''}${m.isOverdraft ? ' <span style="font-size:0.65rem;background:#e9d8fd;color:#553c9a;padding:1px 4px;border-radius:3px;margin-left:3px;">ì´ì</span>' : ''}</span>
                        <span style="display:flex;align-items:center;gap:8px;"><span style="font-weight:700;">${fmtMoney(m.payment)}</span><button class="btn-schedule-pay" onclick="loanSchedulePaid('${loan.id}',${m.principal},${m.payment})">ì™„ë£Œ</button></span>
                    </div>`;
                }).join('')}
                ${isOverdraft
                    ? `<div class="loan-pred-row" style="margin-top:5px;padding-top:5px;border-top:1px solid #e2e8f0;">
                           <span class="loan-pred-label" style="font-size:0.72rem;color:#a0aec0;">í˜„ ì”ì•¡(${fmtMoney(loan.remainingBalance)}) ìœ ì§€ ì‹œ ì˜ˆì¸¡</span>
                       </div>`
                    : `<div class="loan-pred-row" style="margin-top:5px;padding-top:5px;border-top:1px solid #e2e8f0;">
                           <span class="loan-pred-label" style="font-size:0.72rem;color:#a0aec0;">ì™„ë‚© ì˜ˆì •</span>
                           <span style="font-size:0.77rem;font-weight:700;color:#718096;">${payoffStr}</span>
                       </div>`}
            </div>
            <button id="schedule-btn-${loan.id}" class="btn-toggle-schedule" onclick="toggleLoanSchedule('${loan.id}')">â–¼ ìƒí™˜ ì¼ì • ë³´ê¸°</button>
            <div id="schedule-wrap-${loan.id}" class="loan-schedule-wrap">
                <table class="loan-schedule-table">
                    <thead><tr><th>ë‚©ë¶€ì›”</th><th>ì›ê¸ˆ</th><th>ì´ì</th><th>ë‚©ë¶€ì•¡</th><th>ì”ì—¬ê¸ˆ</th><th></th></tr></thead>
                    <tbody>
                        ${schedule.map(m => `<tr class="${m.isGrace ? 'loan-grace-row' : ''}">
                            <td>${m.date}${m.isGrace ? ' <span style="font-size:0.65rem;background:#fef3c7;color:#92400e;padding:1px 4px;border-radius:3px;">ê±°ì¹˜</span>' : ''}</td>
                            <td>${m.isGrace ? '<span style="color:#a0aec0">-</span>' : fmtMoney(m.principal)}</td>
                            <td class="col-interest">${fmtMoney(m.interest)}</td>
                            <td class="col-payment">${fmtMoney(m.payment)}</td>
                            <td class="col-balance">${fmtMoney(m.balance)}</td>
                            <td><button class="btn-schedule-pay" onclick="loanSchedulePaid('${loan.id}',${m.principal},${m.payment})">ì™„ë£Œ</button></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>` : '';

        return `<div class="loan-card">
            <div class="loan-card-header">
                <div>
                    <div class="loan-card-name">ğŸ¦ ${escHtml(loan.name)}${repayLabel ? `<span class="loan-repay-badge">${repayLabel}</span>` : ''}</div>
                    ${loan.memo ? `<div class="loan-card-memo">${escHtml(loan.memo)}</div>` : ''}
                </div>
                <div style="display:flex;gap:6px;">
                    <button class="btn-sm-edit" onclick="editLoan('${loan.id}')">ìˆ˜ì •</button>
                    <button class="btn-sm" onclick="deleteLoan('${loan.id}')">ì‚­ì œ</button>
                </div>
            </div>
            <div class="loan-meta-grid">
                <div class="loan-meta-item">
                    <div class="loan-meta-label">ì”ì—¬ ëŒ€ì¶œê¸ˆ</div>
                    <div class="loan-meta-value" style="color:#e53e3e;">${fmtMoney(loan.remainingBalance || 0)}</div>
                </div>
                <div class="loan-meta-item">
                    <div class="loan-meta-label">ì—° ê¸ˆë¦¬</div>
                    <div class="loan-meta-value">${loan.interestRate != null ? loan.interestRate + '%' : '-'}</div>
                </div>
                <div class="loan-meta-item">
                    <div class="loan-meta-label">ì›” ë‚©ë¶€ì•¡</div>
                    <div class="loan-meta-value">${fmtMoney(loan.monthlyPayment || 0)}</div>
                </div>
                <div class="loan-meta-item">
                    <div class="loan-meta-label">ë‚©ë¶€ì¼</div>
                    <div class="loan-meta-value">ë§¤ì›” ${loan.paymentDay || '-'}ì¼</div>
                </div>
                ${loan.loanEndDate ? `<div class="loan-meta-item">
                    <div class="loan-meta-label">ëŒ€ì¶œê¸°í•œ</div>
                    <div class="loan-meta-value">${fmtYearMonth(loan.loanEndDate)}</div>
                </div>` : ''}
                ${loan.gracePeriodEndDate ? `<div class="loan-meta-item">
                    <div class="loan-meta-label">ê±°ì¹˜ê¸°í•œ</div>
                    <div class="loan-meta-value" style="color:#d69e2e;">${fmtYearMonth(loan.gracePeriodEndDate)}</div>
                </div>` : ''}
            </div>
            <div class="${nextClass}">${nextStr}</div>
            ${predHtml}
        </div>`;
    }).join('');

}

function addLoan() {
    const name             = document.getElementById('loan-name').value.trim();
    const remainingBalance = parseInt(document.getElementById('loan-balance').value) || 0;
    const interestRate     = parseFloat(document.getElementById('loan-rate').value) || null;
    const repaymentType    = document.getElementById('loan-repay-type').value || null;
    const gracePeriodEndDate = document.getElementById('loan-grace-date').value || null;
    const loanEndDate        = document.getElementById('loan-end-date').value || null;
    const _today = new Date(); _today.setHours(0,0,0,0);
    const _graceDate = gracePeriodEndDate ? new Date(gracePeriodEndDate) : null;
    const _endDate   = loanEndDate ? new Date(loanEndDate) : null;
    const gracePeriod     = _graceDate ? monthDiff(_today, _graceDate) : 0;
    const _refDate        = (_graceDate && gracePeriod > 0) ? _graceDate : _today;
    const remainingMonths = _endDate ? monthDiff(_refDate, _endDate) : null;
    const monthlyPayment   = parseInt(document.getElementById('loan-monthly').value) || 0;
    const paymentDay       = parseInt(document.getElementById('loan-payday').value) || null;
    const creditLimit      = parseInt(document.getElementById('loan-limit').value) || null;
    const memo             = document.getElementById('loan-memo').value.trim();
    if (!name) { alert('ëŒ€ì¶œëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

    if (!D.loans) D.loans = [];

    if (_editingLoanId) {
        const idx = D.loans.findIndex(x => x.id === _editingLoanId);
        if (idx >= 0) D.loans[idx] = { ...D.loans[idx], name, remainingBalance, interestRate, repaymentType, gracePeriod, gracePeriodEndDate, remainingMonths, loanEndDate, monthlyPayment, paymentDay, creditLimit, memo };
        _editingLoanId = null;
        const btn = document.getElementById('loan-submit-btn');
        btn.textContent = '+ ëŒ€ì¶œ ì¶”ê°€';
        btn.style.background = '';
        document.getElementById('loan-form-title').textContent = 'ëŒ€ì¶œ ì¶”ê°€';
    } else {
        D.loans.push({ id: uid(), name, remainingBalance, interestRate, repaymentType, gracePeriod, gracePeriodEndDate, remainingMonths, loanEndDate, monthlyPayment, paymentDay, creditLimit, memo });
    }

    save();
    ['loan-name','loan-balance','loan-rate','loan-payday','loan-memo','loan-grace-date','loan-end-date'].forEach(id => {
        document.getElementById(id).value = '';
    });
    document.getElementById('loan-repay-type').value = '';
    document.getElementById('loan-monthly').value = '';
    document.getElementById('loan-calc-preview').style.display = 'none';
    document.getElementById('loan-limit').value = '';
    document.getElementById('loan-payday-od').value = '';
    loanRepayTypeChange(); // í•„ë“œ í‘œì‹œ ìƒíƒœ ì´ˆê¸°í™”
    renderLoans(); updateDashboard();
}

function editLoan(id) {
    const loan = (D.loans || []).find(x => x.id === id);
    if (!loan) return;
    _editingLoanId = id;
    document.getElementById('loan-name').value       = loan.name;
    document.getElementById('loan-balance').value    = loan.remainingBalance || '';
    document.getElementById('loan-rate').value       = loan.interestRate != null ? loan.interestRate : '';
    document.getElementById('loan-repay-type').value = loan.repaymentType || '';
    document.getElementById('loan-payday').value     = loan.paymentDay || '';
    document.getElementById('loan-memo').value       = loan.memo || '';
    document.getElementById('loan-limit').value      = loan.creditLimit || '';
    if (loan.repaymentType === 'overdraft') {
        document.getElementById('loan-payday-od').value = loan.paymentDay || '';
    }
    loanRepayTypeChange(); // í•„ë“œ í‘œì‹œ ìƒíƒœ ë³µì›

    // ë‚ ì§œ í•„ë“œ: ì €ì¥ëœ ë‚ ì§œ ìš°ì„ , ì—†ìœ¼ë©´ ê¸°ì¡´ ê°œì›”ìˆ˜ì—ì„œ ì—­ì‚°
    if (loan.loanEndDate) {
        document.getElementById('loan-end-date').value = loan.loanEndDate;
    } else if (loan.remainingMonths) {
        const d = new Date();
        d.setMonth(d.getMonth() + loan.remainingMonths);
        document.getElementById('loan-end-date').value = fmtDate(d);
    } else {
        document.getElementById('loan-end-date').value = '';
    }

    if (loan.gracePeriodEndDate) {
        document.getElementById('loan-grace-date').value = loan.gracePeriodEndDate;
    } else if (loan.gracePeriod) {
        const d = new Date();
        d.setMonth(d.getMonth() + loan.gracePeriod);
        document.getElementById('loan-grace-date').value = fmtDate(d);
    } else {
        document.getElementById('loan-grace-date').value = '';
    }

    autoCalcLoanPayment();
    const btn = document.getElementById('loan-submit-btn');
    btn.textContent = 'âœï¸ ìˆ˜ì • ì™„ë£Œ';
    btn.style.background = '#f6ad55';
    document.getElementById('loan-form-title').textContent = 'ëŒ€ì¶œ ìˆ˜ì •';

    // í¼ ì¹´ë“œ ìƒë‹¨ìœ¼ë¡œ ì •í™•íˆ ìŠ¤í¬ë¡¤
    const formCard = document.getElementById('loan-form-title').closest('.card');
    const navH = document.querySelector('.main-nav')?.offsetHeight || 60;
    window.scrollTo({ top: formCard.getBoundingClientRect().top + window.scrollY - navH - 12, behavior: 'smooth' });
}

function deleteLoan(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    D.loans = (D.loans || []).filter(x => x.id !== id);
    D.loanPayments = (D.loanPayments || []).filter(x => x.loanId !== id);
    save(); renderLoans(); updateDashboard();
}

function loanSchedulePaid(id, principal, payment) {
    const loan = (D.loans || []).find(x => x.id === id);
    if (!loan) return;
    const msg = principal > 0
        ? `ë‚©ë¶€ì•¡ ${fmtMoney(payment)}ì› ìƒí™˜ ì™„ë£Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.\nì”ì—¬ ëŒ€ì¶œê¸ˆì—ì„œ ì›ê¸ˆ ${fmtMoney(principal)}ì›ì´ ì°¨ê°ë©ë‹ˆë‹¤.`
        : `ì´ì ${fmtMoney(payment)}ì› ë‚©ë¶€ ì™„ë£Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.`;
    if (!confirm(msg)) return;
    if (principal > 0) {
        loan.remainingBalance = Math.max(0, (loan.remainingBalance || 0) - principal);
    }
    save(); renderLoans(); updateDashboard();
}


// â”€â”€ êµ¬ë… ê´€ë¦¬ â”€â”€
function subCycleChange() {
    const cycle = document.getElementById('sub-cycle').value;
    document.getElementById('sub-billing-day-wrap').style.display  = cycle === 'monthly' ? '' : 'none';
    document.getElementById('sub-billing-date-wrap').style.display = cycle === 'yearly'  ? '' : 'none';
}

function getNextBillingDate(sub) {
    const today = new Date(); today.setHours(0,0,0,0);
    if (sub.cycle === 'monthly') {
        const day = sub.billingDay || 1;
        let d = new Date(today.getFullYear(), today.getMonth(), day);
        if (d < today) d = new Date(today.getFullYear(), today.getMonth() + 1, day);
        return d;
    } else {
        const ref = new Date(sub.billingDate);
        let d = new Date(today.getFullYear(), ref.getMonth(), ref.getDate());
        if (d < today) d = new Date(today.getFullYear() + 1, ref.getMonth(), ref.getDate());
        return d;
    }
}

function calcSubSummary() {
    const subs = (D.subscriptions || []).filter(s => s.active);
    const monthlyTotal = subs.reduce((sum, s) =>
        sum + (s.cycle === 'monthly' ? s.amount : Math.round(s.amount / 12)), 0);
    const yearlyTotal  = subs.reduce((sum, s) =>
        sum + (s.cycle === 'monthly' ? s.amount * 12 : s.amount), 0);
    return { monthlyTotal, yearlyTotal, activeCount: subs.length };
}

function renderSubscriptions() {
    const subs = D.subscriptions || [];
    const summaryCard = document.getElementById('sub-summary-card');
    const el = document.getElementById('sub-list');

    if (subs.length === 0) {
        summaryCard.style.display = 'none';
        el.innerHTML = '<div class="empty">ë“±ë¡ëœ êµ¬ë… ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    const { monthlyTotal, yearlyTotal, activeCount } = calcSubSummary();
    summaryCard.style.display = 'block';
    document.getElementById('sub-monthly-total').textContent = fmtMoney(monthlyTotal);
    document.getElementById('sub-yearly-total').textContent  = fmtMoney(yearlyTotal);
    document.getElementById('sub-active-count').textContent  = `${activeCount}ê°œ`;

    const today = new Date(); today.setHours(0,0,0,0);
    const sorted = [...subs].sort((a, b) => {
        if (a.active !== b.active) return a.active ? -1 : 1;
        return getNextBillingDate(a) - getNextBillingDate(b);
    });

    el.innerHTML = sorted.map(sub => {
        const icon      = CATEGORY_ICONS[sub.category] || 'ğŸŒ';
        const nextDate  = getNextBillingDate(sub);
        const daysLeft  = Math.ceil((nextDate - today) / 86400000);
        const isSoon    = daysLeft <= 7 && sub.active;
        const nextStr   = fmtDate(nextDate);
        const cycleBadge = sub.cycle === 'monthly' ? 'sub-badge-monthly' : 'sub-badge-yearly';
        const cycleLabel = sub.cycle === 'monthly' ? 'ë§¤ì›”' : 'ë§¤ë…„';
        const itemClass  = sub.active ? '' : 'sub-inactive';
        const dateClass  = isSoon ? 'sub-next-date soon' : 'sub-next-date';
        const daysText   = isSoon ? ` Â· D-${daysLeft}` : '';

        return `<div class="list-item ${itemClass}">
            <div class="sub-item-inner">
                <label class="sub-toggle" title="${sub.active ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}">
                    <input type="checkbox" ${sub.active ? 'checked' : ''} onchange="toggleSubscription('${sub.id}')">
                    <span class="sub-toggle-slider"></span>
                </label>
                <div class="info" style="min-width:0;">
                    <div class="name">${icon} ${escHtml(sub.name)}<span class="sub-badge ${cycleBadge}">${cycleLabel}</span></div>
                    <div class="${dateClass}">${nextStr}${daysText} Â· ${fmtMoney(sub.amount)}</div>
                </div>
            </div>
            <div class="right" style="flex-shrink:0;">
                <button class="btn-sm-edit" onclick="editSubscription('${sub.id}')">ìˆ˜ì •</button>
                <button class="btn-sm" onclick="deleteSubscription('${sub.id}')">ì‚­ì œ</button>
            </div>
        </div>`;
    }).join('');
}

function addSubscription() {
    const name     = document.getElementById('sub-name').value.trim();
    const category = document.getElementById('sub-category').value;
    const cycle    = document.getElementById('sub-cycle').value;
    const amount   = parseInt(document.getElementById('sub-amount').value);
    if (!name || !amount || amount <= 0) { alert('ì„œë¹„ìŠ¤ëª…ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

    let billingDay = null, billingDate = null;
    if (cycle === 'monthly') {
        billingDay = parseInt(document.getElementById('sub-billing-day').value);
        if (!billingDay || billingDay < 1 || billingDay > 31) { alert('ê²°ì œì¼ì„ 1~31 ì‚¬ì´ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    } else {
        billingDate = document.getElementById('sub-billing-date').value;
        if (!billingDate) { alert('ì—°ê°„ ê²°ì œ ê¸°ì¤€ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    }

    if (!D.subscriptions) D.subscriptions = [];

    if (_editingSubId) {
        const idx = D.subscriptions.findIndex(x => x.id === _editingSubId);
        if (idx >= 0) D.subscriptions[idx] = { ...D.subscriptions[idx], name, category, cycle, amount, billingDay, billingDate };
        _editingSubId = null;
        const btn = document.getElementById('sub-submit-btn');
        btn.textContent = '+ êµ¬ë… ì¶”ê°€';
        btn.style.background = '';
        document.getElementById('sub-form-title').textContent = 'êµ¬ë… ì„œë¹„ìŠ¤ ì¶”ê°€';
    } else {
        D.subscriptions.push({ id: uid(), name, category, cycle, amount, billingDay, billingDate, active: true });
    }

    save();
    document.getElementById('sub-name').value = '';
    document.getElementById('sub-amount').value = '';
    document.getElementById('sub-billing-day').value = '';
    document.getElementById('sub-billing-date').value = '';
    renderSubscriptions();
}

function editSubscription(id) {
    const sub = (D.subscriptions || []).find(x => x.id === id);
    if (!sub) return;
    _editingSubId = id;
    document.getElementById('sub-name').value     = sub.name;
    document.getElementById('sub-category').value = sub.category;
    document.getElementById('sub-cycle').value    = sub.cycle;
    document.getElementById('sub-amount').value   = sub.amount;
    subCycleChange();
    if (sub.cycle === 'monthly') {
        document.getElementById('sub-billing-day').value = sub.billingDay || '';
    } else {
        document.getElementById('sub-billing-date').value = sub.billingDate || '';
    }
    const btn = document.getElementById('sub-submit-btn');
    btn.textContent = 'âœï¸ ìˆ˜ì • ì™„ë£Œ';
    btn.style.background = '#f6ad55';
    document.getElementById('sub-form-title').textContent = 'êµ¬ë… ì„œë¹„ìŠ¤ ìˆ˜ì •';
    document.getElementById('tab-subscription').scrollIntoView({ behavior: 'smooth' });
}

function deleteSubscription(id) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    D.subscriptions = (D.subscriptions || []).filter(x => x.id !== id);
    save(); renderSubscriptions();
}

function toggleSubscription(id) {
    const sub = (D.subscriptions || []).find(x => x.id === id);
    if (!sub) return;
    sub.active = !sub.active;
    save(); renderSubscriptions();
}

window.showTab        = showTab;
window.addSpending    = addSpending;
window.deleteSpending = deleteSpending;
window.addIncome      = addIncome;
window.editIncome     = editIncome;
window.deleteIncome   = deleteIncome;
window.addFixed       = addFixed;
window.editFixed      = editFixed;
window.deleteFixed    = deleteFixed;
window.saveSettings              = saveSettings;
window.dismissOverdraftReminder  = dismissOverdraftReminder;
window.addLoan            = addLoan;
window.editLoan           = editLoan;
window.deleteLoan         = deleteLoan;
window.loanSchedulePaid   = loanSchedulePaid;
window.toggleLoanSchedule = toggleLoanSchedule;
window.loanRepayTypeChange = loanRepayTypeChange;
window.autoCalcLoanPayment = autoCalcLoanPayment;
window.syncOverdraftPayday = syncOverdraftPayday;
window.confirmIncome    = confirmIncome;
window.unconfirmIncome  = unconfirmIncome;
window.confirmFixed     = confirmFixed;
window.unconfirmFixed   = unconfirmFixed;
window.addSubscription    = addSubscription;
window.editSubscription   = editSubscription;
window.deleteSubscription = deleteSubscription;
window.toggleSubscription = toggleSubscription;
window.subCycleChange     = subCycleChange;

// â”€â”€ DOMContentLoaded â”€â”€
document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('targetDate').value = todayStr();
    document.getElementById('log-date').value   = todayStr();

    await Promise.all([
        jk_load(),
        loadFromFirestore().then(() => {
            renderLog(); renderIncome(); renderFixed(); renderSubscriptions(); renderLoans(); updateDashboard();
            document.getElementById('log-desc').addEventListener('keydown',   e => { if (e.key === 'Enter') addSpending(); });
            document.getElementById('log-amount').addEventListener('keydown', e => { if (e.key === 'Enter') addSpending(); });
        })
    ]);
});
</script>

</body></html>
